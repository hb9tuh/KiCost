
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>kicost.spreadsheet &#8212; kicost 1.1.20 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/classic.css" />
    
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">kicost 1.1.20 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">kicost.spreadsheet</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for kicost.spreadsheet</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="c1"># MIT license</span>
<span class="c1">#</span>
<span class="c1"># Copyright (C) 2019 by XESS Corporation / Hildo Guillardi Júnior</span>
<span class="c1">#</span>
<span class="c1"># Permission is hereby granted, free of charge, to any person obtaining a copy</span>
<span class="c1"># of this software and associated documentation files (the &quot;Software&quot;), to deal</span>
<span class="c1"># in the Software without restriction, including without limitation the rights</span>
<span class="c1"># to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</span>
<span class="c1"># copies of the Software, and to permit persons to whom the Software is</span>
<span class="c1"># furnished to do so, subject to the following conditions:</span>
<span class="c1">#</span>
<span class="c1"># The above copyright notice and this permission notice shall be included in</span>
<span class="c1"># all copies or substantial portions of the Software.</span>
<span class="c1">#</span>
<span class="c1"># THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="c1"># IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="c1"># FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span>
<span class="c1"># AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
<span class="c1"># LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span>
<span class="c1"># OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN</span>
<span class="c1"># THE SOFTWARE.</span>

<span class="c1"># Author information.</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s1">&#39;Hildo Guillardi Júnior&#39;</span>
<span class="n">__webpage__</span> <span class="o">=</span> <span class="s1">&#39;https://github.com/hildogjr/&#39;</span>
<span class="n">__company__</span> <span class="o">=</span> <span class="s1">&#39;University of Campinas - Brazil&#39;</span>

<span class="c1"># Debug, language and default configurations.</span>
<span class="kn">from</span> <span class="nn">.global_vars</span> <span class="kn">import</span> <span class="n">SEPRTR</span><span class="p">,</span> <span class="n">DEFAULT_CURRENCY</span><span class="p">,</span> <span class="n">DEFAULT_LANGUAGE</span><span class="p">,</span> <span class="n">DEF_MAX_COLUMN_W</span><span class="p">,</span> <span class="n">W_NOPURCH</span><span class="p">,</span> <span class="n">W_NOQTY</span><span class="p">,</span> <span class="n">ERR_FIELDS</span>

<span class="c1"># Python libraries.</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">ceil</span>
<span class="kn">from</span> <span class="nn">textwrap</span> <span class="kn">import</span> <span class="n">wrap</span>
<span class="kn">import</span> <span class="nn">re</span>  <span class="c1"># Regular expression parser.</span>
<span class="kn">import</span> <span class="nn">xlsxwriter</span>  <span class="c1"># XLSX file interpreter.</span>
<span class="kn">from</span> <span class="nn">xlsxwriter.utility</span> <span class="kn">import</span> <span class="n">xl_rowcol_to_cell</span><span class="p">,</span> <span class="n">xl_range_abs</span>
<span class="kn">from</span> <span class="nn">validators</span> <span class="kn">import</span> <span class="n">url</span> <span class="k">as</span> <span class="n">validate_url</span>  <span class="c1"># URL validator.</span>

<span class="c1"># KiCost libraries.</span>
<span class="kn">from</span> <span class="nn">.distributors</span> <span class="kn">import</span> <span class="n">get_distributor_info</span><span class="p">,</span> <span class="n">ORDER_COL_USERFIELDS</span>
<span class="kn">from</span> <span class="nn">.edas.tools</span> <span class="kn">import</span> <span class="n">order_refs</span><span class="p">,</span> <span class="n">PART_REF_REGEX</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">DistData</span><span class="p">,</span> <span class="n">__version__</span><span class="p">,</span> <span class="n">warning</span><span class="p">,</span> <span class="n">debug_overview</span><span class="p">,</span> <span class="n">debug_detailed</span><span class="p">,</span> <span class="n">debug_general</span><span class="p">,</span> <span class="n">KiCostError</span>

<span class="kn">from</span> <span class="nn">.currency_converter</span> <span class="kn">import</span> <span class="n">CurrencyConverter</span><span class="p">,</span> <span class="n">get_currency_symbol</span><span class="p">,</span> <span class="n">format_currency</span>
<span class="n">currency_convert</span> <span class="o">=</span> <span class="n">CurrencyConverter</span><span class="p">()</span><span class="o">.</span><span class="n">convert</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;create_spreadsheet&#39;</span><span class="p">,</span> <span class="s1">&#39;create_worksheet&#39;</span><span class="p">,</span> <span class="s1">&#39;Spreadsheet&#39;</span><span class="p">]</span>


<span class="c1"># This function is not the same for all xlsxwriter version, generating uncosistent outputs</span>
<span class="k">def</span> <span class="nf">xl_range</span><span class="p">(</span><span class="n">first_row</span><span class="p">,</span> <span class="n">first_col</span><span class="p">,</span> <span class="n">last_row</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">last_col</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">last_row</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">last_row</span> <span class="o">=</span> <span class="n">first_row</span>
    <span class="k">if</span> <span class="n">last_col</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">last_col</span> <span class="o">=</span> <span class="n">first_col</span>
    <span class="n">range1</span> <span class="o">=</span> <span class="n">xl_rowcol_to_cell</span><span class="p">(</span><span class="n">first_row</span><span class="p">,</span> <span class="n">first_col</span><span class="p">)</span>
    <span class="n">range2</span> <span class="o">=</span> <span class="n">xl_rowcol_to_cell</span><span class="p">(</span><span class="n">last_row</span><span class="p">,</span> <span class="n">last_col</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">range1</span> <span class="o">==</span> <span class="n">range2</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">range1</span>
    <span class="k">return</span> <span class="n">range1</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">range2</span>


<span class="c1"># This class is used to configure the spreadsheet creation.</span>
<span class="c1"># Settings can be used inside KiCost or from any tool using KiCost as a module.</span>
<span class="c1"># It was originally created to control the spreadsheet details from KiBot.</span>
<div class="viewcode-block" id="Spreadsheet"><a class="viewcode-back" href="../../kicost.html#kicost.spreadsheet.Spreadsheet">[docs]</a><span class="k">class</span> <span class="nc">Spreadsheet</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; A class to hold the spreadsheet generation settings &#39;&#39;&#39;</span>
    <span class="c1"># Note: upper case members are static. Can be read by the objects, but shouldn&#39;t be modfified by the objects.</span>
    <span class="c1"># They work as configuration parameters to fine tune the spreadsheet content and aspect.</span>
    <span class="c1">#</span>
    <span class="c1"># Microsoft Excel allows a 31 characters longer string for the worksheet name, Google</span>
    <span class="c1"># Spreadsheet 100 and LibreOffice Calc have no limit.</span>
    <span class="n">MAX_LEN_WORKSHEET_NAME</span> <span class="o">=</span> <span class="mi">31</span>
    <span class="c1"># Try to make columns wide enough to make their text readable</span>
    <span class="c1"># If they are bigger than MAX_COL_WIDTH try to make them taller</span>
    <span class="n">ADJUST_ROW_AND_COL_SIZE</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1"># Limit the cells width to this size</span>
    <span class="n">MAX_COL_WIDTH</span> <span class="o">=</span> <span class="n">DEF_MAX_COLUMN_W</span>
    <span class="c1"># Don&#39;t adjust bellow this width</span>
    <span class="n">MIN_COL_WIDTH</span> <span class="o">=</span> <span class="mi">6</span>
    <span class="c1"># Constant used to fine tune the cell adjust</span>
    <span class="c1"># Values bigger than 1.0 makes columns wider, also affects the row heights</span>
    <span class="n">ADJUST_WEIGHT</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="c1"># References separator</span>
    <span class="n">PART_NSEQ_SEPRTR</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span>
    <span class="c1"># Include project/s information</span>
    <span class="n">INCLUDE_PRJ_INFO</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1"># How many rows has the project information</span>
    <span class="n">PRJ_INFO_ROWS</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="c1"># First row for the project information</span>
    <span class="n">PRJ_INFO_START</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># Add date to the top and/or bottom</span>
    <span class="n">ADD_DATE_TOP</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">ADD_DATE_BOTTOM</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">DATE_FIELD_LABEL</span> <span class="o">=</span> <span class="s1">&#39;$ date:&#39;</span>
    <span class="c1"># Default value for number of boards to build.</span>
    <span class="n">DEFAULT_BUILD_QTY</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="c1"># About and credit message at the end of the spreadsheet.</span>
    <span class="n">ABOUT_MSG</span> <span class="o">=</span> <span class="s1">&#39;KiCost</span><span class="se">\N{REGISTERED SIGN}</span><span class="s1"> v&#39;</span> <span class="o">+</span> <span class="n">__version__</span>
    <span class="c1"># Try to group references as ranges</span>
    <span class="n">COLLAPSE_REFS</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1"># Sort the groups</span>
    <span class="n">SORT_GROUPS</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1"># Don&#39;t add the link column</span>
    <span class="n">SUPPRESS_CAT_URL</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1"># Don&#39;t add the description column</span>
    <span class="n">SUPPRESS_DIST_DESC</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1"># Columns to add to the global section</span>
    <span class="n">USER_FIELDS</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># List of selected distributors</span>
    <span class="n">DISTRIBUTORS</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Sort the distributors alphabetically.</span>
    <span class="c1"># But first the web distributors and then the local ones</span>
    <span class="n">SORT_DISTRIBUTORS</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1"># Columns used for the global section</span>
    <span class="n">GLOBAL_COLUMNS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;refs&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;col&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># Outline level (or hierarchy level) for this column.</span>
            <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;Refs&#39;</span><span class="p">,</span>
            <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># Column width (default in this case).</span>
            <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;Schematic identifier for each part.&#39;</span><span class="p">,</span>
            <span class="s1">&#39;static&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>  <span class="c1"># Non static columns are &quot;computed&quot;</span>
        <span class="p">},</span>
        <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;col&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;Value&#39;</span><span class="p">,</span>
            <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;Value of each part.&#39;</span><span class="p">,</span>
            <span class="s1">&#39;static&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s1">&#39;desc&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;col&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;Desc&#39;</span><span class="p">,</span>
            <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;Description of each part.&#39;</span><span class="p">,</span>
            <span class="s1">&#39;static&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s1">&#39;footprint&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;col&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;Footprint&#39;</span><span class="p">,</span>
            <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;PCB footprint for each part.&#39;</span><span class="p">,</span>
            <span class="s1">&#39;static&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s1">&#39;manf&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;col&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
            <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;Manf&#39;</span><span class="p">,</span>
            <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;Manufacturer of each part.&#39;</span><span class="p">,</span>
            <span class="s1">&#39;static&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s1">&#39;manf#&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;col&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
            <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;Manf#&#39;</span><span class="p">,</span>
            <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;Manufacturer number for each part and link to it</span><span class="se">\&#39;</span><span class="s1">s datasheet (Ctrl-click).</span><span class="se">\n</span><span class="s1">&#39;</span>
                       <span class="s1">&#39;Purple -&gt; Obsolete part detected by one of the distributors.&#39;</span><span class="p">,</span>
            <span class="s1">&#39;static&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s1">&#39;qty&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;col&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
            <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;Qty&#39;</span><span class="p">,</span>
            <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s2">&quot;Total number of each part needed.</span><span class="se">\n</span><span class="s2">&quot;</span>
                       <span class="s2">&quot;Gray -&gt; No manf# provided.</span><span class="se">\n</span><span class="s2">&quot;</span>
                       <span class="s2">&quot;Red -&gt; No parts available.</span><span class="se">\n</span><span class="s2">&quot;</span>
                       <span class="s2">&quot;Orange -&gt; Not enough parts available.</span><span class="se">\n</span><span class="s2">&quot;</span>
                       <span class="s2">&quot;Yellow -&gt; Parts available, but haven&#39;t purchased enough.&quot;</span><span class="p">,</span>
            <span class="s1">&#39;static&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s1">&#39;unit_price&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;col&#39;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
            <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;Unit$&#39;</span><span class="p">,</span>
            <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span>  <span class="c1"># Displays up to $99,999.999 without &quot;###&quot;.</span>
            <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;Minimum unit price for each part across all distributors.&#39;</span><span class="p">,</span>
            <span class="s1">&#39;static&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s1">&#39;ext_price&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;col&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
            <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;Ext$&#39;</span><span class="p">,</span>
            <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>  <span class="c1"># Displays up to $9,999,999.99 without &quot;###&quot;.</span>
            <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;Minimum extended price for each part across all distributors.&#39;</span><span class="p">,</span>
            <span class="s1">&#39;static&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="c1"># TODO: &#39;short&#39; Slack quantity. (Not handled, yet.)</span>
    <span class="p">}</span>
    <span class="n">DISTRIBUTOR_COLUMNS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;avail&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;col&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="c1"># column offset within this distributor range of the worksheet.</span>
            <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># Outline level (or hierarchy level) for this column.</span>
            <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;Avail&#39;</span><span class="p">,</span>  <span class="c1"># Column header label.</span>
            <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># Column width (default in this case).</span>
            <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;Available quantity of each part at the distributor.</span><span class="se">\n</span><span class="s1">&#39;</span>
                       <span class="s1">&#39;Red -&gt; No quantity available.</span><span class="se">\n</span><span class="s1">&#39;</span>
                       <span class="s1">&#39;Orange -&gt; Too little quantity available.&#39;</span>
        <span class="p">},</span>
        <span class="s1">&#39;purch&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;col&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;Purch&#39;</span><span class="p">,</span>
            <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;Purchase quantity of each part from this distributor.</span><span class="se">\n</span><span class="s1">Yellow -&gt; This part have a minimum purchase quantity bigger than 1&#39;</span>
                       <span class="s1">&#39; (check the price breaks).</span><span class="se">\n</span><span class="s1">Red -&gt; Purchasing more than the available quantity.&#39;</span>
        <span class="p">},</span>
        <span class="s1">&#39;unit_price&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;col&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;Unit$&#39;</span><span class="p">,</span>
            <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span>  <span class="c1"># Displays up to $99,999.999 without &quot;###&quot;.</span>
            <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;Unit price of each part from this distributor.</span><span class="se">\n</span><span class="s1">Green -&gt; lowest price across distributors.&#39;</span>
        <span class="p">},</span>
        <span class="s1">&#39;moq&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;col&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;MOQ&#39;</span><span class="p">,</span>
            <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;collapsed&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;Minimum Order Quantity. You must buy at least this ammount of components.&#39;</span>
        <span class="p">},</span>
        <span class="s1">&#39;ext_price&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;col&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
            <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;Ext$&#39;</span><span class="p">,</span>
            <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>  <span class="c1"># Displays up to $9,999,999.99 without &quot;###&quot;.</span>
            <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;(Unit Price) x (Purchase Qty) of each part from this distributor.</span><span class="se">\n</span><span class="s1">Red -&gt; Next price break is cheaper.</span><span class="se">\n</span><span class="s1">Green -&gt; Cheapest supplier.&#39;</span>
        <span class="p">},</span>
        <span class="s1">&#39;part_num&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;col&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
            <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;Cat#&#39;</span><span class="p">,</span>
            <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
            <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;Distributor-assigned catalog number for each part and link to it</span><span class="se">\&#39;</span><span class="s1">s web page (ctrl-click). Extra distributor data is shown as comment.&#39;</span>
        <span class="p">},</span>
    <span class="p">}</span>
    <span class="c1"># Cell formats</span>
    <span class="n">WRK_FORMATS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;global&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;font_size&#39;</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span> <span class="s1">&#39;bold&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;font_color&#39;</span><span class="p">:</span> <span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="s1">&#39;bg_color&#39;</span><span class="p">:</span> <span class="s1">&#39;#303030&#39;</span><span class="p">,</span> <span class="s1">&#39;align&#39;</span><span class="p">:</span> <span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="s1">&#39;valign&#39;</span><span class="p">:</span> <span class="s1">&#39;vcenter&#39;</span><span class="p">},</span>
        <span class="s1">&#39;header&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;font_size&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span> <span class="s1">&#39;bold&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;align&#39;</span><span class="p">:</span> <span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="s1">&#39;valign&#39;</span><span class="p">:</span> <span class="s1">&#39;top&#39;</span><span class="p">},</span>
        <span class="s1">&#39;board_qty&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;font_size&#39;</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span> <span class="s1">&#39;bold&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;align&#39;</span><span class="p">:</span> <span class="s1">&#39;right&#39;</span><span class="p">},</span>
        <span class="s1">&#39;total_cost_label&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;font_size&#39;</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span> <span class="s1">&#39;bold&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;align&#39;</span><span class="p">:</span> <span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="s1">&#39;valign&#39;</span><span class="p">:</span> <span class="s1">&#39;vcenter&#39;</span><span class="p">},</span>
        <span class="s1">&#39;unit_cost_label&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;font_size&#39;</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span> <span class="s1">&#39;bold&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;align&#39;</span><span class="p">:</span> <span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="s1">&#39;valign&#39;</span><span class="p">:</span> <span class="s1">&#39;vcenter&#39;</span><span class="p">},</span>
        <span class="s1">&#39;total_cost_currency&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;font_size&#39;</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span> <span class="s1">&#39;bold&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;font_color&#39;</span><span class="p">:</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;valign&#39;</span><span class="p">:</span> <span class="s1">&#39;vcenter&#39;</span><span class="p">},</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;align&#39;</span><span class="p">:</span> <span class="s1">&#39;right&#39;</span><span class="p">},</span>
        <span class="s1">&#39;unit_cost_currency&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;font_size&#39;</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span> <span class="s1">&#39;bold&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;font_color&#39;</span><span class="p">:</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="s1">&#39;valign&#39;</span><span class="p">:</span> <span class="s1">&#39;vcenter&#39;</span><span class="p">},</span>
        <span class="s1">&#39;proj_info_field&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;font_size&#39;</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span> <span class="s1">&#39;bold&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;align&#39;</span><span class="p">:</span> <span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="s1">&#39;valign&#39;</span><span class="p">:</span> <span class="s1">&#39;vcenter&#39;</span><span class="p">},</span>
        <span class="s1">&#39;proj_info&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;font_size&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span> <span class="s1">&#39;align&#39;</span><span class="p">:</span> <span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;valign&#39;</span><span class="p">:</span> <span class="s1">&#39;vcenter&#39;</span><span class="p">},</span>
        <span class="s1">&#39;about_msg&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;font_size&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span> <span class="s1">&#39;align&#39;</span><span class="p">:</span> <span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;valign&#39;</span><span class="p">:</span> <span class="s1">&#39;vcenter&#39;</span><span class="p">},</span>
        <span class="s1">&#39;part_format&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;valign&#39;</span><span class="p">:</span> <span class="s1">&#39;vcenter&#39;</span><span class="p">},</span>
        <span class="s1">&#39;part_format_obsolete&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;valign&#39;</span><span class="p">:</span> <span class="s1">&#39;vcenter&#39;</span><span class="p">,</span> <span class="s1">&#39;bg_color&#39;</span><span class="p">:</span> <span class="s1">&#39;#c000c0&#39;</span><span class="p">},</span>
        <span class="s1">&#39;found_part_pct&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;font_size&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;bold&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;italic&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;valign&#39;</span><span class="p">:</span> <span class="s1">&#39;vcenter&#39;</span><span class="p">},</span>
        <span class="s1">&#39;best_price&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;bg_color&#39;</span><span class="p">:</span> <span class="s1">&#39;#80FF80&#39;</span><span class="p">,</span> <span class="p">},</span>
        <span class="s1">&#39;not_manf_codes&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;bg_color&#39;</span><span class="p">:</span> <span class="s1">&#39;#AAAAAA&#39;</span><span class="p">},</span>
        <span class="s1">&#39;not_available&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;bg_color&#39;</span><span class="p">:</span> <span class="s1">&#39;#FF0000&#39;</span><span class="p">,</span> <span class="s1">&#39;font_color&#39;</span><span class="p">:</span> <span class="s1">&#39;white&#39;</span><span class="p">},</span>
        <span class="s1">&#39;order_too_much&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;bg_color&#39;</span><span class="p">:</span> <span class="s1">&#39;#FF0000&#39;</span><span class="p">,</span> <span class="s1">&#39;font_color&#39;</span><span class="p">:</span> <span class="s1">&#39;white&#39;</span><span class="p">},</span>
        <span class="s1">&#39;order_min_qty&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;bg_color&#39;</span><span class="p">:</span> <span class="s1">&#39;#FFFF00&#39;</span><span class="p">},</span>
        <span class="s1">&#39;too_few_available&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;bg_color&#39;</span><span class="p">:</span> <span class="s1">&#39;#FF9900&#39;</span><span class="p">,</span> <span class="s1">&#39;font_color&#39;</span><span class="p">:</span> <span class="s1">&#39;black&#39;</span><span class="p">},</span>
        <span class="s1">&#39;too_few_purchased&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;bg_color&#39;</span><span class="p">:</span> <span class="s1">&#39;#FFFF00&#39;</span><span class="p">},</span>
        <span class="s1">&#39;not_stocked&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;font_color&#39;</span><span class="p">:</span> <span class="s1">&#39;#909090&#39;</span><span class="p">,</span> <span class="s1">&#39;align&#39;</span><span class="p">:</span> <span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="s1">&#39;valign&#39;</span><span class="p">:</span> <span class="s1">&#39;vcenter&#39;</span><span class="p">},</span>
        <span class="s1">&#39;currency&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;valign&#39;</span><span class="p">:</span> <span class="s1">&#39;vcenter&#39;</span><span class="p">},</span>
        <span class="s1">&#39;currency_unit&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;valign&#39;</span><span class="p">:</span> <span class="s1">&#39;vcenter&#39;</span><span class="p">},</span>
        <span class="s1">&#39;order&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;valign&#39;</span><span class="p">:</span> <span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="s1">&#39;text_wrap&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workbook</span><span class="p">,</span> <span class="n">worksheet_name</span><span class="p">,</span> <span class="n">prj_info</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="n">DEFAULT_CURRENCY</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Spreadsheet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">workbook</span> <span class="o">=</span> <span class="n">workbook</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worksheet_name</span> <span class="o">=</span> <span class="n">worksheet_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">purchase_description_seprtr</span> <span class="o">=</span> <span class="n">SEPRTR</span>  <span class="c1"># Purchase description separator.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prj_info</span> <span class="o">=</span> <span class="n">prj_info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">START_ROW</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PRJ_INFO_START</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">PRJ_INFO_ROWS</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">prj_info</span><span class="p">)</span>
        <span class="c1"># Currency format and symbol definition</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_currency</span><span class="p">(</span><span class="n">currency</span><span class="p">)</span>
        <span class="c1"># Extra information characteristics of the components gotten in the page that will be displayed as comment in the &#39;cat#&#39; column.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extra_info_display</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;desc&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;tolerance&#39;</span><span class="p">,</span> <span class="s1">&#39;footprint&#39;</span><span class="p">,</span> <span class="s1">&#39;power&#39;</span><span class="p">,</span> <span class="s1">&#39;current&#39;</span><span class="p">,</span> <span class="s1">&#39;voltage&#39;</span><span class="p">,</span> <span class="s1">&#39;frequency&#39;</span><span class="p">,</span> <span class="s1">&#39;temp_coeff&#39;</span><span class="p">,</span> <span class="s1">&#39;manf&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">]</span>
        <span class="c1"># Create the worksheet that holds the pricing information.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wks</span> <span class="o">=</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_worksheet</span><span class="p">(</span><span class="n">worksheet_name</span><span class="p">)</span>
        <span class="c1"># Data to performe cell size adjust</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col_widths</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">row_heights</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col_levels</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collapsed</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

<div class="viewcode-block" id="Spreadsheet.set_currency"><a class="viewcode-back" href="../../kicost.html#kicost.spreadsheet.Spreadsheet.set_currency">[docs]</a>    <span class="k">def</span> <span class="nf">set_currency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">currency</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">currency</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">currency</span> <span class="o">=</span> <span class="n">currency</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">currency_symbol</span> <span class="o">=</span> <span class="n">get_currency_symbol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currency</span><span class="p">,</span> <span class="n">locale</span><span class="o">=</span><span class="n">DEFAULT_LANGUAGE</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">currency_format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">currency_symbol</span> <span class="o">+</span> <span class="s1">&#39;#,##0.00&#39;</span>
            <span class="c1"># Unit cost can be very small for pasive components, we use one extra digit</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">currency_format_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">currency_format</span> <span class="o">+</span> <span class="s1">&#39;0&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">currency</span> <span class="o">=</span> <span class="n">DEFAULT_CURRENCY</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">currency_symbol</span> <span class="o">=</span> <span class="s1">&#39;US$&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">currency_format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">currency_format_unit</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span></div>

<div class="viewcode-block" id="Spreadsheet.write_string"><a class="viewcode-back" href="../../kicost.html#kicost.spreadsheet.Spreadsheet.write_string">[docs]</a>    <span class="k">def</span> <span class="nf">write_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="nb">format</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; worksheet.write_string wrapper to keep track of the string sizes. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wks</span><span class="o">.</span><span class="n">write_string</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrk_formats</span><span class="p">[</span><span class="nb">format</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compute_cell_size</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="nb">format</span><span class="p">)</span></div>

<div class="viewcode-block" id="Spreadsheet.write_url"><a class="viewcode-back" href="../../kicost.html#kicost.spreadsheet.Spreadsheet.write_url">[docs]</a>    <span class="k">def</span> <span class="nf">write_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">cell_format</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tip</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; worksheet.write_url wrapper to keep track of the string sizes. &quot;&quot;&quot;</span>
        <span class="nb">format</span> <span class="o">=</span> <span class="n">cell_format</span> <span class="k">if</span> <span class="n">cell_format</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrk_formats</span><span class="p">[</span><span class="n">cell_format</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wks</span><span class="o">.</span><span class="n">write_url</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">cell_format</span><span class="o">=</span><span class="nb">format</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="n">string</span><span class="p">,</span> <span class="n">tip</span><span class="o">=</span><span class="n">tip</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">string</span> <span class="k">if</span> <span class="n">string</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compute_cell_size</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">cell_format</span><span class="p">)</span></div>

<div class="viewcode-block" id="Spreadsheet.compute_cell_size"><a class="viewcode-back" href="../../kicost.html#kicost.spreadsheet.Spreadsheet.compute_cell_size">[docs]</a>    <span class="k">def</span> <span class="nf">compute_cell_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="nb">format</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Compute cell size adjusts &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1"># Compute a scale factor</span>
        <span class="n">multiplier</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">if</span> <span class="nb">format</span><span class="p">:</span>
            <span class="nb">format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">WRK_FORMATS</span><span class="p">[</span><span class="nb">format</span><span class="p">]</span>
            <span class="n">size</span> <span class="o">=</span> <span class="nb">format</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;font_size&#39;</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span>
            <span class="n">bold</span> <span class="o">=</span> <span class="nb">format</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="c1"># Try to adjust according to font size and weigth</span>
            <span class="n">multiplier</span> <span class="o">+=</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="mi">11</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.08</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.1</span> <span class="k">if</span> <span class="n">bold</span> <span class="k">else</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="n">multiplier</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ADJUST_WEIGHT</span>
        <span class="c1"># Adjust the sizes</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">wrap</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">Spreadsheet</span><span class="o">.</span><span class="n">MAX_COL_WIDTH</span><span class="p">))</span>
        <span class="n">h</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">ceil</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">lines</span><span class="p">))</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">w</span> <span class="o">&gt;</span> <span class="n">Spreadsheet</span><span class="o">.</span><span class="n">MIN_COL_WIDTH</span><span class="p">:</span>
            <span class="n">cur_w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col_widths</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">Spreadsheet</span><span class="o">.</span><span class="n">MIN_COL_WIDTH</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">col_widths</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">cur_w</span><span class="p">),</span> <span class="n">Spreadsheet</span><span class="o">.</span><span class="n">MAX_COL_WIDTH</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">h</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">cur_h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">row_heights</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">h</span> <span class="o">&gt;</span> <span class="n">cur_h</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">row_heights</span><span class="p">[</span><span class="n">row</span><span class="p">]</span> <span class="o">=</span> <span class="n">h</span></div>

<div class="viewcode-block" id="Spreadsheet.adjust_row_and_col_sizes"><a class="viewcode-back" href="../../kicost.html#kicost.spreadsheet.Spreadsheet.adjust_row_and_col_sizes">[docs]</a>    <span class="k">def</span> <span class="nf">adjust_row_and_col_sizes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Adjust the column and row sizes using the values computed by compute_cell_size &quot;&quot;&quot;</span>
        <span class="n">debug_overview</span><span class="p">(</span><span class="s1">&#39;Adjusting cell sizes&#39;</span><span class="p">)</span>
        <span class="n">debug_detailed</span><span class="p">(</span><span class="s1">&#39;Column adjusts: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">col_widths</span><span class="p">))</span>
        <span class="n">debug_detailed</span><span class="p">(</span><span class="s1">&#39;Row adjusts: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">row_heights</span><span class="p">))</span>
        <span class="n">debug_detailed</span><span class="p">(</span><span class="s1">&#39;Levels: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">col_levels</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">width</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">col_widths</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col_levels</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">level</span><span class="p">:</span>
                <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="n">level</span><span class="p">}</span>
                <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">collapsed</span><span class="p">:</span>
                    <span class="c1"># Libreoffice 7 workaround: collapsed cols aren&#39;t collapsed at start-up</span>
                    <span class="n">ops</span><span class="p">[</span><span class="s1">&#39;hidden&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">ops</span><span class="p">[</span><span class="s1">&#39;collapsed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wks</span><span class="o">.</span><span class="n">set_column</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">width</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ops</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wks</span><span class="o">.</span><span class="n">set_column</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">width</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Set the level for the columns that we didn&#39;t adjust</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">level</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">col_levels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">col_widths</span><span class="p">:</span>
                <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="n">level</span><span class="p">}</span>
                <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">collapsed</span><span class="p">:</span>
                    <span class="n">ops</span><span class="p">[</span><span class="s1">&#39;hidden&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">ops</span><span class="p">[</span><span class="s1">&#39;collapsed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wks</span><span class="o">.</span><span class="n">set_column</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ops</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="n">height</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">row_heights</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wks</span><span class="o">.</span><span class="n">set_row</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mf">15.0</span> <span class="o">*</span> <span class="n">height</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ADJUST_WEIGHT</span><span class="p">)</span></div>

<div class="viewcode-block" id="Spreadsheet.set_column"><a class="viewcode-back" href="../../kicost.html#kicost.spreadsheet.Spreadsheet.set_column">[docs]</a>    <span class="k">def</span> <span class="nf">set_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">collapsed</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ADJUST_ROW_AND_COL_SIZE</span><span class="p">:</span>
            <span class="c1"># Add it to the computation</span>
            <span class="k">if</span> <span class="n">width</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">col_widths</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">col_widths</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">width</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">level</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">col_levels</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">level</span>
            <span class="k">if</span> <span class="n">collapsed</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">collapsed</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Do it now</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wks</span><span class="o">.</span><span class="n">set_column</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="n">level</span><span class="p">})</span></div>

<div class="viewcode-block" id="Spreadsheet.get_for_sheet"><a class="viewcode-back" href="../../kicost.html#kicost.spreadsheet.Spreadsheet.get_for_sheet">[docs]</a>    <span class="k">def</span> <span class="nf">get_for_sheet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Returns a name qualified for this sheet &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;&#39;</span><span class="si">{}</span><span class="s2">&#39;!</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worksheet_name</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span></div>

<div class="viewcode-block" id="Spreadsheet.get_ref"><a class="viewcode-back" href="../../kicost.html#kicost.spreadsheet.Spreadsheet.get_ref">[docs]</a>    <span class="k">def</span> <span class="nf">get_ref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Returns an absolute reference to row/col on this sheet &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;=&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_for_sheet</span><span class="p">(</span><span class="n">xl_rowcol_to_cell</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">row_abs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">col_abs</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span></div>

<div class="viewcode-block" id="Spreadsheet.get_range"><a class="viewcode-back" href="../../kicost.html#kicost.spreadsheet.Spreadsheet.get_range">[docs]</a>    <span class="k">def</span> <span class="nf">get_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row1</span><span class="p">,</span> <span class="n">col1</span><span class="p">,</span> <span class="n">row2</span><span class="p">,</span> <span class="n">col2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Returns an absolute reference to a range on this sheet &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;=&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_for_sheet</span><span class="p">(</span><span class="n">xl_range_abs</span><span class="p">(</span><span class="n">row1</span><span class="p">,</span> <span class="n">col1</span><span class="p">,</span> <span class="n">row2</span><span class="p">,</span> <span class="n">col2</span><span class="p">))</span></div>

<div class="viewcode-block" id="Spreadsheet.define_name_ref"><a class="viewcode-back" href="../../kicost.html#kicost.spreadsheet.Spreadsheet.define_name_ref">[docs]</a>    <span class="k">def</span> <span class="nf">define_name_ref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Define a local variable assigned to an absolute position in the sheet &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">workbook</span><span class="o">.</span><span class="n">define_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_for_sheet</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ref</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">))</span></div>

<div class="viewcode-block" id="Spreadsheet.define_name_range"><a class="viewcode-back" href="../../kicost.html#kicost.spreadsheet.Spreadsheet.define_name_range">[docs]</a>    <span class="k">def</span> <span class="nf">define_name_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">row1</span><span class="p">,</span> <span class="n">col1</span><span class="p">,</span> <span class="n">row2</span><span class="p">,</span> <span class="n">col2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Define a local variable assigned to an absolute range in the sheet &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">workbook</span><span class="o">.</span><span class="n">define_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_for_sheet</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_range</span><span class="p">(</span><span class="n">row1</span><span class="p">,</span> <span class="n">col1</span><span class="p">,</span> <span class="n">row2</span><span class="p">,</span> <span class="n">col2</span><span class="p">))</span></div>

<div class="viewcode-block" id="Spreadsheet.add_date"><a class="viewcode-back" href="../../kicost.html#kicost.spreadsheet.Spreadsheet.add_date">[docs]</a>    <span class="k">def</span> <span class="nf">add_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wks</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">DATE_FIELD_LABEL</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;proj_info_field&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wks</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;proj_info&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="Spreadsheet.conditional_format_r"><a class="viewcode-back" href="../../kicost.html#kicost.spreadsheet.Spreadsheet.conditional_format_r">[docs]</a>    <span class="k">def</span> <span class="nf">conditional_format_r</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rng</span><span class="p">,</span> <span class="n">criteria</span><span class="p">,</span> <span class="nb">format</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Ranges didn&#39;t seem to be working on LibreOffice 7.0.4.2</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;formula&#39;</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;cell&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">}</span>
        <span class="n">ops</span><span class="p">[</span><span class="s1">&#39;criteria&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">criteria</span>
        <span class="n">ops</span><span class="p">[</span><span class="s1">&#39;format&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrk_formats</span><span class="p">[</span><span class="nb">format</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wks</span><span class="o">.</span><span class="n">conditional_format</span><span class="p">(</span><span class="n">rng</span><span class="p">,</span> <span class="n">ops</span><span class="p">)</span></div>

<div class="viewcode-block" id="Spreadsheet.conditional_format"><a class="viewcode-back" href="../../kicost.html#kicost.spreadsheet.Spreadsheet.conditional_format">[docs]</a>    <span class="k">def</span> <span class="nf">conditional_format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">criteria</span><span class="p">,</span> <span class="nb">format</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conditional_format_r</span><span class="p">(</span><span class="n">xl_range</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">row</span><span class="p">),</span> <span class="n">criteria</span><span class="p">,</span> <span class="nb">format</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="create_spreadsheet"><a class="viewcode-back" href="../../kicost.html#kicost.spreadsheet.create_spreadsheet">[docs]</a><span class="k">def</span> <span class="nf">create_spreadsheet</span><span class="p">(</span><span class="n">parts</span><span class="p">,</span> <span class="n">prj_info</span><span class="p">,</span> <span class="n">spreadsheet_filename</span><span class="p">,</span> <span class="n">dist_list</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="n">DEFAULT_CURRENCY</span><span class="p">,</span>
                       <span class="n">collapse_refs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">suppress_cat_url</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">user_fields</span><span class="o">=</span><span class="p">[],</span> <span class="n">variant</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span>
                       <span class="n">max_column_width</span><span class="o">=</span><span class="n">DEF_MAX_COLUMN_W</span><span class="p">,</span> <span class="n">suppress_dist_desc</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Create a spreadsheet using the info for the parts (including their HTML trees).&#39;&#39;&#39;</span>
    <span class="n">basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">spreadsheet_filename</span><span class="p">)</span>
    <span class="n">debug_overview</span><span class="p">(</span><span class="s1">&#39;Creating the </span><span class="se">\&#39;</span><span class="si">{}</span><span class="se">\&#39;</span><span class="s1"> spreadsheet...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">basename</span><span class="p">))</span>
    <span class="c1"># Adjust the name of the work_sheet (add variant and limit len)</span>
    <span class="n">worksheet_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">basename</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Default name for pricing worksheet.</span>
    <span class="n">variant</span> <span class="o">=</span> <span class="n">variant</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">variant</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Append an indication of the variant to the worksheet title.</span>
        <span class="c1"># Remove any special characters that might be illegal in a</span>
        <span class="c1"># worksheet name since the variant might be a regular expression.</span>
        <span class="c1"># Fix the maximum worksheet name, priorize the variant string cutting</span>
        <span class="c1"># the board project.</span>
        <span class="n">variant</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[\[\]</span><span class="se">\\</span><span class="s1">\/\|\?\*\:\(\)]&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">variant</span><span class="p">[:(</span><span class="n">Spreadsheet</span><span class="o">.</span><span class="n">MAX_LEN_WORKSHEET_NAME</span><span class="p">)])</span>
        <span class="n">worksheet_name</span> <span class="o">+=</span> <span class="s1">&#39;.&#39;</span>
        <span class="n">worksheet_name</span> <span class="o">=</span> <span class="n">worksheet_name</span><span class="p">[:(</span><span class="n">Spreadsheet</span><span class="o">.</span><span class="n">MAX_LEN_WORKSHEET_NAME</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">variant</span><span class="p">))]</span>
        <span class="n">worksheet_name</span> <span class="o">+=</span> <span class="n">variant</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">worksheet_name</span> <span class="o">=</span> <span class="n">worksheet_name</span><span class="p">[:</span><span class="n">Spreadsheet</span><span class="o">.</span><span class="n">MAX_LEN_WORKSHEET_NAME</span><span class="p">]</span>
    <span class="c1"># Create spreadsheet file.</span>
    <span class="k">with</span> <span class="n">xlsxwriter</span><span class="o">.</span><span class="n">Workbook</span><span class="p">(</span><span class="n">spreadsheet_filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">workbook</span><span class="p">:</span>
        <span class="n">Spreadsheet</span><span class="o">.</span><span class="n">COLLAPSE_REFS</span> <span class="o">=</span> <span class="n">collapse_refs</span>
        <span class="n">Spreadsheet</span><span class="o">.</span><span class="n">SUPPRESS_CAT_URL</span> <span class="o">=</span> <span class="n">suppress_cat_url</span>
        <span class="n">Spreadsheet</span><span class="o">.</span><span class="n">SUPPRESS_DIST_DESC</span> <span class="o">=</span> <span class="n">suppress_dist_desc</span>
        <span class="n">Spreadsheet</span><span class="o">.</span><span class="n">USER_FIELDS</span> <span class="o">=</span> <span class="n">user_fields</span>
        <span class="n">Spreadsheet</span><span class="o">.</span><span class="n">DISTRIBUTORS</span> <span class="o">=</span> <span class="n">dist_list</span>
        <span class="k">if</span> <span class="n">max_column_width</span><span class="p">:</span>
            <span class="n">Spreadsheet</span><span class="o">.</span><span class="n">ADJUST_ROW_AND_COL_SIZE</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">Spreadsheet</span><span class="o">.</span><span class="n">MAX_COL_WIDTH</span> <span class="o">=</span> <span class="n">max_column_width</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Spreadsheet</span><span class="o">.</span><span class="n">ADJUST_ROW_AND_COL_SIZE</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">ss</span> <span class="o">=</span> <span class="n">Spreadsheet</span><span class="p">(</span><span class="n">workbook</span><span class="p">,</span> <span class="n">worksheet_name</span><span class="p">,</span> <span class="n">prj_info</span><span class="p">,</span> <span class="n">currency</span><span class="p">)</span>
        <span class="n">create_worksheet</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span> <span class="n">parts</span><span class="p">)</span></div>


<div class="viewcode-block" id="create_worksheet"><a class="viewcode-back" href="../../kicost.html#kicost.spreadsheet.create_worksheet">[docs]</a><span class="k">def</span> <span class="nf">create_worksheet</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span> <span class="n">parts</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Create a worksheet using the info for the parts (including their HTML trees).&#39;&#39;&#39;</span>
    <span class="c1"># Force all currency related cells to use the &quot;currency_format&quot;</span>
    <span class="n">ss</span><span class="o">.</span><span class="n">WRK_FORMATS</span><span class="p">[</span><span class="s1">&#39;total_cost_currency&#39;</span><span class="p">][</span><span class="s1">&#39;num_format&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">currency_format</span>
    <span class="n">ss</span><span class="o">.</span><span class="n">WRK_FORMATS</span><span class="p">[</span><span class="s1">&#39;unit_cost_currency&#39;</span><span class="p">][</span><span class="s1">&#39;num_format&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">currency_format</span>
    <span class="n">ss</span><span class="o">.</span><span class="n">WRK_FORMATS</span><span class="p">[</span><span class="s1">&#39;currency&#39;</span><span class="p">][</span><span class="s1">&#39;num_format&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">currency_format</span>
    <span class="n">ss</span><span class="o">.</span><span class="n">WRK_FORMATS</span><span class="p">[</span><span class="s1">&#39;currency_unit&#39;</span><span class="p">][</span><span class="s1">&#39;num_format&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">currency_format_unit</span>
    <span class="c1"># Enable test wrap if we will adjust the sizes</span>
    <span class="k">if</span> <span class="n">ss</span><span class="o">.</span><span class="n">ADJUST_ROW_AND_COL_SIZE</span><span class="p">:</span>
        <span class="n">ss</span><span class="o">.</span><span class="n">WRK_FORMATS</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">][</span><span class="s1">&#39;text_wrap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">ss</span><span class="o">.</span><span class="n">WRK_FORMATS</span><span class="p">[</span><span class="s1">&#39;part_format&#39;</span><span class="p">][</span><span class="s1">&#39;text_wrap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">ss</span><span class="o">.</span><span class="n">WRK_FORMATS</span><span class="p">[</span><span class="s1">&#39;part_format_obsolete&#39;</span><span class="p">][</span><span class="s1">&#39;text_wrap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1"># Create the various format styles used by various spreadsheet items.</span>
    <span class="n">ss</span><span class="o">.</span><span class="n">wrk_formats</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ss</span><span class="o">.</span><span class="n">WRK_FORMATS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">ss</span><span class="o">.</span><span class="n">wrk_formats</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">workbook</span><span class="o">.</span><span class="n">add_format</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="c1"># Add the distinctive header format for each distributor to the `dict` of formats.</span>
    <span class="n">base_hdr_format</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">WRK_FORMATS</span><span class="p">[</span><span class="s1">&#39;global&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">ss</span><span class="o">.</span><span class="n">DISTRIBUTORS</span><span class="p">:</span>
        <span class="n">hdr_format</span> <span class="o">=</span> <span class="n">base_hdr_format</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">hdr_format</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">get_distributor_info</span><span class="p">(</span><span class="n">d</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">format</span><span class="p">)</span>
        <span class="n">ss</span><span class="o">.</span><span class="n">wrk_formats</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">workbook</span><span class="o">.</span><span class="n">add_format</span><span class="p">(</span><span class="n">hdr_format</span><span class="p">)</span>
    <span class="c1"># Define some useful shortcuts</span>
    <span class="n">wks</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">wks</span>
    <span class="n">prj_info</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">prj_info</span>
    <span class="n">next_row</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">PRJ_INFO_START</span>
    <span class="c1"># Set the row &amp; column for entering the part information in the sheet.</span>
    <span class="n">START_COL</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">BOARD_QTY_ROW</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">PRJ_INFO_START</span>
    <span class="n">UNIT_COST_ROW</span> <span class="o">=</span> <span class="n">BOARD_QTY_ROW</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">TOTAL_COST_ROW</span> <span class="o">=</span> <span class="n">BOARD_QTY_ROW</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">START_ROW</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">START_ROW</span>
    <span class="n">LABEL_ROW</span> <span class="o">=</span> <span class="n">START_ROW</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">COL_HDR_ROW</span> <span class="o">=</span> <span class="n">LABEL_ROW</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ss</span><span class="o">.</span><span class="n">SUPPRESS_CAT_URL</span><span class="p">:</span>
        <span class="c1"># Add a extra column for the hyperlink.</span>
        <span class="n">d_width</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ss</span><span class="o">.</span><span class="n">DISTRIBUTOR_COLUMNS</span><span class="p">)</span>
        <span class="n">ss</span><span class="o">.</span><span class="n">DISTRIBUTOR_COLUMNS</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;link&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;col&#39;</span><span class="p">:</span> <span class="n">d_width</span><span class="p">,</span> <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;URL&#39;</span><span class="p">,</span> <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;Distributor catalog link (ctrl-click).&#39;</span><span class="p">}})</span>
        <span class="n">ss</span><span class="o">.</span><span class="n">DISTRIBUTOR_COLUMNS</span><span class="p">[</span><span class="s1">&#39;part_num&#39;</span><span class="p">][</span><span class="s1">&#39;comment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Distributor-assigned catalog number for each part. Extra distributor data is shown as comment.&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ss</span><span class="o">.</span><span class="n">SUPPRESS_DIST_DESC</span><span class="p">:</span>
        <span class="c1"># Add a extra column for the description.</span>
        <span class="n">d_width</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ss</span><span class="o">.</span><span class="n">DISTRIBUTOR_COLUMNS</span><span class="p">)</span>
        <span class="n">ss</span><span class="o">.</span><span class="n">DISTRIBUTOR_COLUMNS</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;col&#39;</span><span class="p">:</span> <span class="n">d_width</span><span class="p">,</span> <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;Description&#39;</span><span class="p">,</span> <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;Distributor description&#39;</span><span class="p">}})</span>

    <span class="c1"># Make a list of alphabetically-ordered distributors with web distributors before locals.</span>
    <span class="n">debug_overview</span><span class="p">(</span><span class="s1">&#39;Sorting the distributors...&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ss</span><span class="o">.</span><span class="n">SORT_DISTRIBUTORS</span><span class="p">:</span>
        <span class="n">web_dists</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">ss</span><span class="o">.</span><span class="n">DISTRIBUTORS</span> <span class="k">if</span> <span class="n">get_distributor_info</span><span class="p">(</span><span class="n">d</span><span class="p">)</span><span class="o">.</span><span class="n">is_web</span><span class="p">()])</span>
        <span class="n">local_dists</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">ss</span><span class="o">.</span><span class="n">DISTRIBUTORS</span> <span class="k">if</span> <span class="n">get_distributor_info</span><span class="p">(</span><span class="n">d</span><span class="p">)</span><span class="o">.</span><span class="n">is_local</span><span class="p">()])</span>
        <span class="n">dist_list</span> <span class="o">=</span> <span class="n">web_dists</span> <span class="o">+</span> <span class="n">local_dists</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dist_list</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">DISTRIBUTORS</span>

    <span class="c1"># Fill the global information (not distributor-specific)</span>
    <span class="c1"># Skip the prices, will fill them after we fill the distributors</span>
    <span class="c1"># dist_1st_col = the column immediately to the right of the global data.</span>
    <span class="c1"># qty_col = the column where the quantity needed of each part is stored.</span>
    <span class="n">dist_1st_col</span><span class="p">,</span> <span class="n">refs_col</span><span class="p">,</span> <span class="n">qty_col</span><span class="p">,</span> <span class="n">columns_global</span> <span class="o">=</span> <span class="n">add_globals_to_worksheet</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span> <span class="n">START_ROW</span><span class="p">,</span> <span class="n">START_COL</span><span class="p">,</span> <span class="n">TOTAL_COST_ROW</span><span class="p">,</span> <span class="n">parts</span><span class="p">,</span> <span class="n">dist_list</span><span class="p">)</span>
    <span class="n">ss</span><span class="o">.</span><span class="n">globals_width</span> <span class="o">=</span> <span class="n">dist_1st_col</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="c1"># Fill the distributors information</span>
    <span class="n">debug_overview</span><span class="p">(</span><span class="s1">&#39;Writing the distributors information...&#39;</span><span class="p">)</span>
    <span class="n">next_col</span> <span class="o">=</span> <span class="n">dist_1st_col</span>
    <span class="k">for</span> <span class="n">dist</span> <span class="ow">in</span> <span class="n">dist_list</span><span class="p">:</span>
        <span class="n">next_col</span> <span class="o">=</span> <span class="n">add_dist_to_worksheet</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span> <span class="n">columns_global</span><span class="p">,</span> <span class="n">START_ROW</span><span class="p">,</span> <span class="n">next_col</span><span class="p">,</span> <span class="n">UNIT_COST_ROW</span><span class="p">,</span> <span class="n">TOTAL_COST_ROW</span><span class="p">,</span> <span class="n">refs_col</span><span class="p">,</span> <span class="n">qty_col</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="n">parts</span><span class="p">)</span>

    <span class="c1"># Fill the global prices</span>
    <span class="n">next_line</span> <span class="o">=</span> <span class="n">add_global_prices_to_workheet</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span> <span class="n">START_ROW</span><span class="p">,</span> <span class="n">START_COL</span><span class="p">,</span> <span class="n">TOTAL_COST_ROW</span><span class="p">,</span> <span class="n">parts</span><span class="p">,</span> <span class="n">dist_list</span><span class="p">,</span> <span class="n">columns_global</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i_prj</span><span class="p">,</span> <span class="n">p_info</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">prj_info</span><span class="p">):</span>
        <span class="c1"># Add project information to track the project (in a printed version of the BOM) and the date because of price variations.</span>
        <span class="n">i_prj_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i_prj</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">prj_info</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">ss</span><span class="o">.</span><span class="n">INCLUDE_PRJ_INFO</span><span class="p">:</span>
            <span class="n">wks</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">next_row</span><span class="p">,</span> <span class="n">START_COL</span><span class="p">,</span> <span class="s1">&#39;Prj</span><span class="si">{}</span><span class="s1">:&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i_prj_str</span><span class="p">),</span> <span class="n">ss</span><span class="o">.</span><span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;proj_info_field&#39;</span><span class="p">])</span>
            <span class="n">wks</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">next_row</span><span class="p">,</span> <span class="n">START_COL</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">p_info</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">],</span> <span class="n">ss</span><span class="o">.</span><span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;proj_info&#39;</span><span class="p">])</span>
            <span class="n">wks</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">next_row</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">START_COL</span><span class="p">,</span> <span class="s1">&#39;Co.:&#39;</span><span class="p">,</span> <span class="n">ss</span><span class="o">.</span><span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;proj_info_field&#39;</span><span class="p">])</span>
            <span class="n">wks</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">next_row</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">START_COL</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">p_info</span><span class="p">[</span><span class="s1">&#39;company&#39;</span><span class="p">],</span> <span class="n">ss</span><span class="o">.</span><span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;proj_info&#39;</span><span class="p">])</span>
            <span class="n">wks</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">next_row</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">START_COL</span><span class="p">,</span> <span class="s1">&#39;Prj date:&#39;</span><span class="p">,</span> <span class="n">ss</span><span class="o">.</span><span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;proj_info_field&#39;</span><span class="p">])</span>
            <span class="n">wks</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">next_row</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">START_COL</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">p_info</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">],</span> <span class="n">ss</span><span class="o">.</span><span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;proj_info&#39;</span><span class="p">])</span>

        <span class="c1"># Create the cell where the quantity of boards to assemble is entered.</span>
        <span class="c1"># Place the board qty cells near the right side of the global info.</span>
        <span class="n">ss</span><span class="o">.</span><span class="n">write_string</span><span class="p">(</span><span class="n">next_row</span><span class="p">,</span> <span class="n">dist_1st_col</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;Board Qty&#39;</span> <span class="o">+</span> <span class="n">i_prj_str</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="s1">&#39;board_qty&#39;</span><span class="p">)</span>
        <span class="c1"># Set initial board quantity.</span>
        <span class="n">wks</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">next_row</span><span class="p">,</span> <span class="n">dist_1st_col</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">p_info</span><span class="p">[</span><span class="s1">&#39;qty&#39;</span><span class="p">],</span> <span class="n">ss</span><span class="o">.</span><span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;board_qty&#39;</span><span class="p">])</span>
        <span class="c1"># Define the named cell where the total board quantity can be found.</span>
        <span class="n">ss</span><span class="o">.</span><span class="n">define_name_ref</span><span class="p">(</span><span class="s1">&#39;BoardQty&#39;</span> <span class="o">+</span> <span class="n">i_prj_str</span><span class="p">,</span> <span class="n">next_row</span><span class="p">,</span> <span class="n">dist_1st_col</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Create the cell to show total cost of board parts for each distributor.</span>
        <span class="n">ss</span><span class="o">.</span><span class="n">write_string</span><span class="p">(</span><span class="n">next_row</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dist_1st_col</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;Total Cost&#39;</span> <span class="o">+</span> <span class="n">i_prj_str</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="s1">&#39;total_cost_label&#39;</span><span class="p">)</span>
        <span class="n">wks</span><span class="o">.</span><span class="n">write_comment</span><span class="p">(</span><span class="n">next_row</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dist_1st_col</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;Use the minimum extend price across distributors not taking account available quantities.&#39;</span><span class="p">)</span>
        <span class="c1"># Define the named cell where the total cost can be found.</span>
        <span class="n">ss</span><span class="o">.</span><span class="n">define_name_ref</span><span class="p">(</span><span class="s1">&#39;TotalCost&#39;</span> <span class="o">+</span> <span class="n">i_prj_str</span><span class="p">,</span> <span class="n">next_row</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dist_1st_col</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Create the cell to show unit cost of (each project) board parts.</span>
        <span class="n">ss</span><span class="o">.</span><span class="n">write_string</span><span class="p">(</span><span class="n">next_row</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">dist_1st_col</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;Unit Cost</span><span class="si">{}</span><span class="s1">:&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i_prj_str</span><span class="p">),</span> <span class="s1">&#39;unit_cost_label&#39;</span><span class="p">)</span>

        <span class="n">next_row</span> <span class="o">+=</span> <span class="n">ss</span><span class="o">.</span><span class="n">PRJ_INFO_ROWS</span>

    <span class="c1"># Add general information of the scrap to track price modifications.</span>
    <span class="k">if</span> <span class="n">ss</span><span class="o">.</span><span class="n">ADD_DATE_TOP</span><span class="p">:</span>
        <span class="n">ss</span><span class="o">.</span><span class="n">add_date</span><span class="p">(</span><span class="n">next_row</span><span class="p">,</span> <span class="n">START_COL</span><span class="p">)</span>
    <span class="c1"># Add the total cost of all projects together.</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">prj_info</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># Create the row to show total cost of board parts for each distributor.</span>
        <span class="n">ss</span><span class="o">.</span><span class="n">write_string</span><span class="p">(</span><span class="n">next_row</span><span class="p">,</span> <span class="n">dist_1st_col</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;Total Prjs Cost:&#39;</span><span class="p">,</span> <span class="s1">&#39;total_cost_label&#39;</span><span class="p">)</span>
        <span class="c1"># Define the named cell where the total cost can be found.</span>
        <span class="n">ss</span><span class="o">.</span><span class="n">define_name_ref</span><span class="p">(</span><span class="s1">&#39;TotalCost&#39;</span><span class="p">,</span> <span class="n">next_row</span><span class="p">,</span> <span class="n">dist_1st_col</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">next_row</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># Freeze view of the global information and the column headers, but</span>
    <span class="c1"># allow the distributor-specific part info to scroll.</span>
    <span class="n">wks</span><span class="o">.</span><span class="n">freeze_panes</span><span class="p">(</span><span class="n">COL_HDR_ROW</span><span class="p">,</span> <span class="n">dist_1st_col</span><span class="p">)</span>

    <span class="c1"># Add general information of the scrap to track price modifications.</span>
    <span class="k">if</span> <span class="n">ss</span><span class="o">.</span><span class="n">ADD_DATE_BOTTOM</span><span class="p">:</span>
        <span class="n">ss</span><span class="o">.</span><span class="n">add_date</span><span class="p">(</span><span class="n">next_line</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">START_COL</span><span class="p">)</span>
        <span class="n">next_line</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="c1"># Add the KiCost package information at the end of the spreadsheet to debug</span>
    <span class="c1"># information at the forum and &quot;advertising&quot;.</span>
    <span class="n">wks</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">next_line</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">START_COL</span><span class="p">,</span> <span class="n">ss</span><span class="o">.</span><span class="n">ABOUT_MSG</span><span class="p">,</span> <span class="n">ss</span><span class="o">.</span><span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;about_msg&#39;</span><span class="p">])</span>
    <span class="c1"># Optionally adjust cell sizes</span>
    <span class="k">if</span> <span class="n">ss</span><span class="o">.</span><span class="n">ADJUST_ROW_AND_COL_SIZE</span><span class="p">:</span>
        <span class="n">ss</span><span class="o">.</span><span class="n">adjust_row_and_col_sizes</span><span class="p">()</span></div>


<span class="k">def</span> <span class="nf">get_ref_key</span><span class="p">(</span><span class="n">part</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; Helper function to sort the references &#39;&#39;&#39;</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">PART_REF_REGEX</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">part</span><span class="o">.</span><span class="n">first_ref</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">part</span><span class="o">.</span><span class="n">collapsed_refs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">subpart_num</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;subpart_num&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;prefix&#39;</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;ref_num&#39;</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="n">subpart_num</span><span class="p">)</span> <span class="k">if</span> <span class="n">subpart_num</span> <span class="k">else</span> <span class="mi">0</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">add_globals_to_worksheet</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span> <span class="n">start_row</span><span class="p">,</span> <span class="n">start_col</span><span class="p">,</span> <span class="n">total_cost_row</span><span class="p">,</span> <span class="n">parts</span><span class="p">,</span> <span class="n">dist_list</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Add global part data to the spreadsheet.&#39;&#39;&#39;</span>

    <span class="n">debug_overview</span><span class="p">(</span><span class="s1">&#39;Writing the global information...&#39;</span><span class="p">)</span>

    <span class="n">wks</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">wks</span>
    <span class="c1"># Columns for the various types of global part data.</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">GLOBAL_COLUMNS</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="c1"># Created a list of columns sorted by column position</span>
    <span class="n">columns_list</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
    <span class="k">for</span> <span class="nb">id</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">columns</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># Remove not used columns by the field not founded in ALL the parts. This give</span>
        <span class="c1"># better visualization on notebooks (small screens) and optimization to print.</span>
        <span class="k">if</span> <span class="nb">id</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;manf&#39;</span><span class="p">,</span> <span class="s1">&#39;desc&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">part</span><span class="p">:</span> <span class="n">part</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="p">),</span> <span class="n">parts</span><span class="p">)),</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">columns_list</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;col&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">id</span>
    <span class="c1"># Compact the list</span>
    <span class="n">columns_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">columns_list</span> <span class="k">if</span> <span class="n">c</span><span class="p">]</span>

    <span class="c1"># Add quantity columns to deal with different quantities in the BOM files. The</span>
    <span class="c1"># original quantity column will be the total of each item.</span>
    <span class="n">num_prj</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ss</span><span class="o">.</span><span class="n">prj_info</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">num_prj</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># Number of parts for each project</span>
        <span class="n">ss</span><span class="o">.</span><span class="n">num_parts</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">num_prj</span>
        <span class="n">insert_idx</span> <span class="o">=</span> <span class="n">columns_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;qty&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i_prj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_prj</span><span class="p">):</span>
            <span class="c1"># Add one column to quantify the quantity for each project.</span>
            <span class="n">s_prj</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i_prj</span><span class="p">)</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;qty_prj&#39;</span> <span class="o">+</span> <span class="n">s_prj</span>
            <span class="n">columns</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;qty&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">columns</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Qty.Prj&#39;</span> <span class="o">+</span> <span class="n">s_prj</span>
            <span class="n">columns</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;comment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Total number of each part needed to assembly the project </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s_prj</span><span class="p">)</span>
            <span class="n">columns_list</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">insert_idx</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">insert_idx</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># Enter user-defined fields into the global part data columns structure.</span>
    <span class="n">insert_idx</span> <span class="o">=</span> <span class="n">columns_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;footprint&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">user_field</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">ss</span><span class="o">.</span><span class="n">USER_FIELDS</span><span class="p">)):</span>
        <span class="c1"># Separate the information</span>
        <span class="n">comment</span> <span class="o">=</span> <span class="s1">&#39;User-defined field.&#39;</span>
        <span class="n">level</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">user_field</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="c1"># Support a dict with extra info:</span>
            <span class="n">field</span> <span class="o">=</span> <span class="n">user_field</span><span class="p">[</span><span class="s1">&#39;field&#39;</span><span class="p">]</span>
            <span class="n">user_field_id</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">comment</span> <span class="o">=</span> <span class="n">user_field</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;comment&#39;</span><span class="p">,</span> <span class="n">comment</span><span class="p">)</span>
            <span class="n">level</span> <span class="o">=</span> <span class="n">user_field</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;level&#39;</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">user_field</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Just the name of the field</span>
            <span class="n">user_field_id</span> <span class="o">=</span> <span class="n">user_field</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">user_field</span>
        <span class="c1"># Skip the user field if it&#39;s already in the list of data columns.</span>
        <span class="k">if</span> <span class="n">user_field_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
            <span class="c1"># Insert user field immediately to right of the &#39;desc&#39; column.</span>
            <span class="n">columns_list</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">insert_idx</span><span class="p">,</span> <span class="n">user_field_id</span><span class="p">)</span>
            <span class="n">columns</span><span class="p">[</span><span class="n">user_field_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="n">level</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">label</span><span class="p">,</span> <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="n">comment</span><span class="p">,</span> <span class="s1">&#39;static&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>

    <span class="n">num_cols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns_list</span><span class="p">)</span>
    <span class="n">row</span> <span class="o">=</span> <span class="n">start_row</span>  <span class="c1"># Start building global section at this row.</span>

    <span class="c1"># Add label for global section.</span>
    <span class="n">wks</span><span class="o">.</span><span class="n">merge_range</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">start_col</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">num_cols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Global Part Info&quot;</span><span class="p">,</span> <span class="n">ss</span><span class="o">.</span><span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;global&#39;</span><span class="p">])</span>
    <span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># Go to next row.</span>

    <span class="c1"># Add column headers.</span>
    <span class="c1"># Memorize the columns positions, this `col`</span>
    <span class="n">debug_general</span><span class="p">(</span><span class="n">columns_list</span><span class="p">)</span>
    <span class="n">col</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">columns_list</span><span class="p">):</span>
        <span class="n">ss</span><span class="o">.</span><span class="n">write_string</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">columns</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">],</span> <span class="s1">&#39;header&#39;</span><span class="p">)</span>
        <span class="n">wks</span><span class="o">.</span><span class="n">write_comment</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">columns</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;comment&#39;</span><span class="p">])</span>
        <span class="n">ss</span><span class="o">.</span><span class="n">set_column</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">columns</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;width&#39;</span><span class="p">],</span> <span class="n">columns</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;level&#39;</span><span class="p">])</span>
        <span class="n">col</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span>
    <span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># Go to next row.</span>

    <span class="c1"># Add data for each part to the spreadsheet.</span>
    <span class="c1"># Order the references and collapse, if asked:</span>
    <span class="c1"># e.g. J3, J2, J1, J6 =&gt; J1, J2, J3 J6. # `collapse=False`</span>
    <span class="c1"># e.g. J3, J2, J1, J6 =&gt; J1-J3, J6.. # `collapse=True`</span>
    <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">:</span>
        <span class="n">part</span><span class="o">.</span><span class="n">collapsed_refs</span><span class="p">,</span> <span class="n">part</span><span class="o">.</span><span class="n">first_ref</span> <span class="o">=</span> <span class="n">order_refs</span><span class="p">(</span><span class="n">part</span><span class="o">.</span><span class="n">refs</span><span class="p">,</span> <span class="n">collapse</span><span class="o">=</span><span class="n">ss</span><span class="o">.</span><span class="n">COLLAPSE_REFS</span><span class="p">,</span> <span class="n">ref_sep</span><span class="o">=</span><span class="n">ss</span><span class="o">.</span><span class="n">PART_NSEQ_SEPRTR</span><span class="p">)</span>

    <span class="c1"># Then, order the part references with priority ref prefix, ref num, and subpart num.</span>
    <span class="k">if</span> <span class="n">ss</span><span class="o">.</span><span class="n">SORT_GROUPS</span><span class="p">:</span>
        <span class="n">parts</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">get_ref_key</span><span class="p">)</span>

    <span class="c1"># Add the global part data to the spreadsheet.</span>
    <span class="n">col_qty</span> <span class="o">=</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">col</span><span class="p">[</span><span class="s1">&#39;qty&#39;</span><span class="p">]</span>
    <span class="n">col_refs</span> <span class="o">=</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">col</span><span class="p">[</span><span class="s1">&#39;refs&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">:</span>

        <span class="c1"># Enter part references.</span>
        <span class="n">ss</span><span class="o">.</span><span class="n">write_string</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col_refs</span><span class="p">,</span> <span class="n">part</span><span class="o">.</span><span class="n">collapsed_refs</span><span class="p">,</span> <span class="s1">&#39;part_format&#39;</span><span class="p">)</span>

        <span class="c1"># Fill the static data for the part (value, desc, footprint, manf, manf#)</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">columns_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">columns</span><span class="p">[</span><span class="n">field</span><span class="p">][</span><span class="s1">&#39;static&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># Fields found in the XML are lower-cased, so do the same for the column key.</span>
            <span class="n">field_name</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">field_value</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
            <span class="n">cell_format</span> <span class="o">=</span> <span class="s1">&#39;part_format&#39;</span>
            <span class="n">n_col</span> <span class="o">=</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">col</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">field_name</span> <span class="o">==</span> <span class="s1">&#39;manf#&#39;</span><span class="p">:</span>
                <span class="c1"># Note: empty manf# with link will show the URL</span>
                <span class="n">link</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;datasheet&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">link</span><span class="p">:</span>
                    <span class="c1"># Use the the datasheet link got in the distributor if not available any in the BOM / schematic.</span>
                    <span class="n">link</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">datasheet</span>
                <span class="c1"># Mark obsolete parts</span>
                <span class="k">if</span> <span class="n">part</span><span class="o">.</span><span class="n">lifecycle</span> <span class="ow">and</span> <span class="n">part</span><span class="o">.</span><span class="n">lifecycle</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;obsolete&#39;</span><span class="p">):</span>
                    <span class="n">cell_format</span> <span class="o">=</span> <span class="s1">&#39;part_format_obsolete&#39;</span>
                <span class="k">if</span> <span class="n">link</span> <span class="ow">and</span> <span class="n">validate_url</span><span class="p">(</span><span class="n">link</span><span class="p">):</span>
                    <span class="c1"># Just put the link if is a valid format.</span>
                    <span class="n">ss</span><span class="o">.</span><span class="n">write_url</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">n_col</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="n">field_value</span><span class="p">,</span> <span class="n">cell_format</span><span class="o">=</span><span class="n">cell_format</span><span class="p">)</span>
                    <span class="k">continue</span>
            <span class="k">if</span> <span class="n">field_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Skip empty cells</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">field_name</span> <span class="o">==</span> <span class="s1">&#39;footprint&#39;</span><span class="p">:</span>
                <span class="c1"># TODO add future dependence of &quot;electro-grammar&quot; (https://github.com/kitspace/electro-grammar)</span>
                <span class="n">field_value_footprint</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\:(.*)&#39;</span><span class="p">,</span> <span class="n">field_value</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">field_value_footprint</span><span class="p">:</span>
                    <span class="n">field_value</span> <span class="o">=</span> <span class="n">field_value_footprint</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ss</span><span class="o">.</span><span class="n">write_string</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">n_col</span><span class="p">,</span> <span class="n">field_value</span><span class="p">,</span> <span class="n">cell_format</span><span class="p">)</span>

        <span class="c1"># Enter total part quantity needed.</span>
        <span class="n">total</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">qty_total_spreadsheet</span>
        <span class="k">if</span> <span class="n">num_prj</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Multifiles BOM case, write each quantity and after,</span>
            <span class="c1"># in the &#39;qty&#39; column the total quantity as ceil of</span>
            <span class="c1"># the total quantity (to ceil use a Microsoft Excel</span>
            <span class="c1"># compatible function.</span>
            <span class="k">for</span> <span class="n">i_prj</span><span class="p">,</span> <span class="n">p_info</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ss</span><span class="o">.</span><span class="n">prj_info</span><span class="p">):</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">qty</span><span class="p">[</span><span class="n">i_prj</span><span class="p">]</span> <span class="o">*</span> <span class="n">p_info</span><span class="p">[</span><span class="s1">&#39;qty&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">part</span><span class="o">.</span><span class="n">qty</span><span class="p">[</span><span class="n">i_prj</span><span class="p">]:</span>
                    <span class="n">ss</span><span class="o">.</span><span class="n">num_parts</span><span class="p">[</span><span class="n">i_prj</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="nb">id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i_prj</span><span class="p">)</span>
                <span class="c1"># Qty.PrjN</span>
                <span class="n">wks</span><span class="o">.</span><span class="n">write_formula</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">col</span><span class="p">[</span><span class="s1">&#39;qty_prj&#39;</span><span class="o">+</span><span class="nb">id</span><span class="p">],</span> <span class="n">part</span><span class="o">.</span><span class="n">qty_str</span><span class="p">[</span><span class="n">i_prj</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;BoardQty&#39;</span><span class="o">+</span><span class="nb">id</span><span class="p">),</span> <span class="n">ss</span><span class="o">.</span><span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;part_format&#39;</span><span class="p">],</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>
            <span class="c1"># Build Quantity</span>
            <span class="n">wks</span><span class="o">.</span><span class="n">write_formula</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col_qty</span><span class="p">,</span>
                              <span class="s1">&#39;=CEILING(SUM(</span><span class="si">{}</span><span class="s1">:</span><span class="si">{}</span><span class="s1">),1)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xl_rowcol_to_cell</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">col</span><span class="p">[</span><span class="s1">&#39;qty_prj0&#39;</span><span class="p">]),</span>
                                                              <span class="n">xl_rowcol_to_cell</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col_qty</span><span class="o">-</span><span class="mi">1</span><span class="p">)),</span>
                              <span class="n">ss</span><span class="o">.</span><span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;part_format&#39;</span><span class="p">],</span>
                              <span class="n">value</span><span class="o">=</span><span class="n">total</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Build Quantity</span>
            <span class="n">wks</span><span class="o">.</span><span class="n">write_formula</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col_qty</span><span class="p">,</span> <span class="n">part</span><span class="o">.</span><span class="n">qty_str</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;BoardQty&#39;</span><span class="p">),</span> <span class="n">ss</span><span class="o">.</span><span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;part_format&#39;</span><span class="p">],</span> <span class="n">value</span><span class="o">=</span><span class="n">total</span><span class="p">)</span>
        <span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># Go to next row.</span>

    <span class="c1"># Return column following the globals so we know where to start next set of cells.</span>
    <span class="c1"># Also return the columns where the references and quantity needed of each part are stored.</span>
    <span class="k">return</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">num_cols</span><span class="p">,</span> <span class="n">col_refs</span><span class="p">,</span> <span class="n">col_qty</span><span class="p">,</span> <span class="n">col</span>


<span class="k">def</span> <span class="nf">add_global_prices_to_workheet</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span> <span class="n">start_row</span><span class="p">,</span> <span class="n">start_col</span><span class="p">,</span> <span class="n">total_cost_row</span><span class="p">,</span> <span class="n">parts</span><span class="p">,</span> <span class="n">dist_list</span><span class="p">,</span> <span class="n">col</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Add global prices data to the spreadsheet.&#39;&#39;&#39;</span>

    <span class="n">debug_overview</span><span class="p">(</span><span class="s1">&#39;Writing the global prices information...&#39;</span><span class="p">)</span>
    <span class="n">wks</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">wks</span>
    <span class="n">num_cols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
    <span class="n">num_parts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>
    <span class="n">num_prj</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ss</span><span class="o">.</span><span class="n">prj_info</span><span class="p">)</span>
    <span class="n">used_currencies</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">row</span> <span class="o">=</span> <span class="n">start_row</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">PART_INFO_FIRST_ROW</span> <span class="o">=</span> <span class="n">row</span>  <span class="c1"># Starting row of part info.</span>
    <span class="n">PART_INFO_LAST_ROW</span> <span class="o">=</span> <span class="n">PART_INFO_FIRST_ROW</span> <span class="o">+</span> <span class="n">num_parts</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># Last row of part info.</span>
    <span class="n">total_cost</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">num_prj</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">total_cost_l</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">num_prj</span>  <span class="c1"># Multiproject total cost</span>
    <span class="c1"># Compute the columns for each distributor</span>
    <span class="n">col_dist</span> <span class="o">=</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">num_cols</span>
    <span class="n">dist_width</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ss</span><span class="o">.</span><span class="n">DISTRIBUTOR_COLUMNS</span><span class="p">)</span>
    <span class="n">dist_cols</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">dist</span> <span class="ow">in</span> <span class="n">dist_list</span><span class="p">:</span>
        <span class="n">dist_cols</span><span class="p">[</span><span class="n">dist</span><span class="p">]</span> <span class="o">=</span> <span class="n">col_dist</span>
        <span class="n">col_dist</span> <span class="o">+=</span> <span class="n">dist_width</span>
    <span class="n">col_ext_price</span> <span class="o">=</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">col</span><span class="p">[</span><span class="s1">&#39;ext_price&#39;</span><span class="p">]</span>
    <span class="n">col_qty</span> <span class="o">=</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">col</span><span class="p">[</span><span class="s1">&#39;qty&#39;</span><span class="p">]</span>
    <span class="n">col_unit_price</span> <span class="o">=</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">col</span><span class="p">[</span><span class="s1">&#39;unit_price&#39;</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">:</span>
        <span class="c1"># Gather the cell references for calculating minimum unit price and part availability.</span>
        <span class="n">dist_unit_prices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dist_qty_avail</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dist_qty_purchased</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dist_code_avail</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">dist</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ss</span><span class="o">.</span><span class="n">DISTRIBUTORS</span><span class="p">):</span>
            <span class="c1"># Get the currencies used among all distributors.</span>
            <span class="n">dd</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">dd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dd</span> <span class="ow">and</span> <span class="n">dd</span><span class="o">.</span><span class="n">currency</span><span class="p">:</span>
                <span class="n">used_currencies</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dd</span><span class="o">.</span><span class="n">currency</span><span class="p">)</span>
            <span class="c1"># Cells we use</span>
            <span class="n">col_dist</span> <span class="o">=</span> <span class="n">dist_cols</span><span class="p">[</span><span class="n">dist</span><span class="p">]</span>
            <span class="n">avail_cell</span> <span class="o">=</span> <span class="n">xl_rowcol_to_cell</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col_dist</span><span class="o">+</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">purch_cell</span> <span class="o">=</span> <span class="n">xl_rowcol_to_cell</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col_dist</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">unit_cell</span> <span class="o">=</span> <span class="n">xl_rowcol_to_cell</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col_dist</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">cat_cell</span> <span class="o">=</span> <span class="n">xl_rowcol_to_cell</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col_dist</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span>
            <span class="c1"># Get the contents of the unit price cell for this part (row) and distributor (column+offset).</span>
            <span class="n">dist_unit_prices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unit_cell</span><span class="p">)</span>
            <span class="c1"># Get the contents of the quantity purchased cell for this part and distributor</span>
            <span class="c1"># unless the unit price is not a number in which case return 0.</span>
            <span class="n">dist_qty_purchased</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;IF(ISNUMBER(</span><span class="si">{unit}</span><span class="s1">),</span><span class="si">{purch}</span><span class="s1">,0)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">unit_cell</span><span class="p">,</span> <span class="n">purch</span><span class="o">=</span><span class="n">purch_cell</span><span class="p">))</span>
            <span class="c1"># Get the contents of the quantity available cell of this part from this distributor.</span>
            <span class="n">dist_qty_avail</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">avail_cell</span><span class="p">)</span>
            <span class="c1"># Get the contents of the manufacture and distributors codes.</span>
            <span class="n">dist_code_avail</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;ISBLANK(</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cat_cell</span><span class="p">))</span>

        <span class="c1"># If part do not have manf# code or distributor codes, color quantity cell gray.</span>
        <span class="n">criteria</span> <span class="o">=</span> <span class="s1">&#39;=AND(ISBLANK(</span><span class="si">{g}</span><span class="s1">),</span><span class="si">{d}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">g</span><span class="o">=</span><span class="n">xl_rowcol_to_cell</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">col</span><span class="p">[</span><span class="s1">&#39;manf#&#39;</span><span class="p">]),</span>  <span class="c1"># Manf# column also have to be blank.</span>
                                                   <span class="n">d</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dist_code_avail</span><span class="p">)</span> <span class="k">if</span> <span class="n">dist_code_avail</span> <span class="k">else</span> <span class="s1">&#39;TRUE()&#39;</span><span class="p">))</span>
        <span class="n">ss</span><span class="o">.</span><span class="n">conditional_format</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col_qty</span><span class="p">,</span> <span class="n">criteria</span><span class="p">,</span> <span class="s1">&#39;not_manf_codes&#39;</span><span class="p">)</span>

        <span class="n">unit_price</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">min_price</span> <span class="k">if</span> <span class="n">part</span><span class="o">.</span><span class="n">min_price</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">ext_price</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">qty_total_spreadsheet</span> <span class="o">*</span> <span class="n">unit_price</span>
        <span class="n">total_cost</span> <span class="o">+=</span> <span class="n">ext_price</span>
        <span class="k">if</span> <span class="n">num_prj</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">q</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">part</span><span class="o">.</span><span class="n">qty</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">q</span><span class="p">:</span>
                    <span class="n">total_cost_l</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">q</span> <span class="o">*</span> <span class="n">unit_price</span>
        <span class="c1"># Enter the spreadsheet formula for calculating the minimum extended price (based on the unit price found on next formula).</span>
        <span class="n">formula</span> <span class="o">=</span> <span class="s1">&#39;=IF(AND(ISNUMBER(</span><span class="si">{qty}</span><span class="s1">),ISNUMBER(</span><span class="si">{unit_price}</span><span class="s1">)),</span><span class="si">{qty}</span><span class="s1">*</span><span class="si">{unit_price}</span><span class="s1">,&quot;&quot;)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                  <span class="n">qty</span><span class="o">=</span><span class="n">xl_rowcol_to_cell</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col_qty</span><span class="p">),</span> <span class="n">unit_price</span><span class="o">=</span><span class="n">xl_rowcol_to_cell</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col_unit_price</span><span class="p">))</span>
        <span class="n">wks</span><span class="o">.</span><span class="n">write_formula</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col_ext_price</span><span class="p">,</span> <span class="n">formula</span><span class="p">,</span> <span class="n">ss</span><span class="o">.</span><span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;currency&#39;</span><span class="p">],</span> <span class="n">value</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">ext_price</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="k">if</span> <span class="n">ext_price</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="c1"># Minimum unit price</span>
        <span class="k">if</span> <span class="n">ss</span><span class="o">.</span><span class="n">DISTRIBUTORS</span><span class="p">:</span>
            <span class="c1"># Enter the spreadsheet formula to find this part&#39;s minimum unit price across all distributors.</span>
            <span class="n">values</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dist_unit_prices</span><span class="p">)</span>
            <span class="n">wks</span><span class="o">.</span><span class="n">write_formula</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col_unit_price</span><span class="p">,</span> <span class="s1">&#39;=IF(MIN(</span><span class="si">{v}</span><span class="s1">)&lt;&gt;0,MIN(</span><span class="si">{v}</span><span class="s1">),&quot;&quot;)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="o">=</span><span class="n">values</span><span class="p">),</span> <span class="n">ss</span><span class="o">.</span><span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;currency_unit&#39;</span><span class="p">],</span>
                              <span class="n">value</span><span class="o">=</span><span class="n">unit_price</span> <span class="k">if</span> <span class="n">unit_price</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="c1"># If part is unavailable from all distributors, color quantity cell red.</span>
            <span class="n">ss</span><span class="o">.</span><span class="n">conditional_format</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col_qty</span><span class="p">,</span> <span class="s1">&#39;=IF(SUM(</span><span class="si">{}</span><span class="s1">)=0,1,0)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dist_qty_avail</span><span class="p">)),</span> <span class="s1">&#39;not_available&#39;</span><span class="p">)</span>
            <span class="c1"># If total available part quantity is less than needed quantity, color cell orange.</span>
            <span class="n">ss</span><span class="o">.</span><span class="n">conditional_format</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col_qty</span><span class="p">,</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;too_few_available&#39;</span><span class="p">,</span> <span class="s1">&#39;=SUM(</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dist_qty_avail</span><span class="p">)))</span>
            <span class="c1"># If total purchased part quantity is less than needed quantity, color cell yellow.</span>
            <span class="n">ss</span><span class="o">.</span><span class="n">conditional_format</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col_qty</span><span class="p">,</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;too_few_purchased&#39;</span><span class="p">,</span> <span class="s1">&#39;=SUM(</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dist_qty_purchased</span><span class="p">)))</span>

        <span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># Go to next row.</span>

    <span class="c1"># Sum the extended prices for all the parts to get the total minimum cost.</span>
    <span class="c1"># If have read multiple BOM file calculate it by `SUMPRODUCT()` of the</span>
    <span class="c1"># board project quantity components &#39;qty_prj*&#39; by unitary price &#39;Unit$&#39;.</span>
    <span class="n">total_cost_col</span> <span class="o">=</span> <span class="n">col_ext_price</span>
    <span class="k">if</span> <span class="n">num_prj</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">unit_price_range</span> <span class="o">=</span> <span class="n">xl_range</span><span class="p">(</span><span class="n">PART_INFO_FIRST_ROW</span><span class="p">,</span> <span class="n">col_unit_price</span><span class="p">,</span> <span class="n">PART_INFO_LAST_ROW</span><span class="p">)</span>
        <span class="c1"># Add the cost for 1 board and for the total of boards</span>
        <span class="k">for</span> <span class="n">i_prj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_prj</span><span class="p">):</span>
            <span class="n">qty_col</span> <span class="o">=</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">col</span><span class="p">[</span><span class="s1">&#39;qty_prj</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i_prj</span><span class="p">)]</span>
            <span class="n">row_tc</span> <span class="o">=</span> <span class="n">total_cost_row</span> <span class="o">+</span> <span class="n">ss</span><span class="o">.</span><span class="n">PRJ_INFO_ROWS</span><span class="o">*</span><span class="n">i_prj</span>
            <span class="n">wks</span><span class="o">.</span><span class="n">write_formula</span><span class="p">(</span><span class="n">row_tc</span><span class="p">,</span> <span class="n">total_cost_col</span><span class="p">,</span> <span class="s1">&#39;=SUMPRODUCT(</span><span class="si">{qty_range}</span><span class="s1">,</span><span class="si">{unit_price_range}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                              <span class="n">unit_price_range</span><span class="o">=</span><span class="n">unit_price_range</span><span class="p">,</span> <span class="n">qty_range</span><span class="o">=</span><span class="n">xl_range</span><span class="p">(</span><span class="n">PART_INFO_FIRST_ROW</span><span class="p">,</span> <span class="n">qty_col</span><span class="p">,</span> <span class="n">PART_INFO_LAST_ROW</span><span class="p">)),</span>
                              <span class="n">ss</span><span class="o">.</span><span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;total_cost_currency&#39;</span><span class="p">],</span> <span class="n">value</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">total_cost_l</span><span class="p">[</span><span class="n">i_prj</span><span class="p">]</span> <span class="o">*</span> <span class="n">ss</span><span class="o">.</span><span class="n">prj_info</span><span class="p">[</span><span class="n">i_prj</span><span class="p">][</span><span class="s1">&#39;qty&#39;</span><span class="p">],</span> <span class="mi">4</span><span class="p">))</span>
            <span class="c1"># Create the cell to show unit cost of (each project) board parts.</span>
            <span class="n">wks</span><span class="o">.</span><span class="n">write_formula</span><span class="p">(</span><span class="n">row_tc</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">total_cost_col</span><span class="p">,</span> <span class="s2">&quot;=TotalCost</span><span class="si">{0}</span><span class="s2">/BoardQty</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i_prj</span><span class="p">),</span> <span class="n">ss</span><span class="o">.</span><span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;unit_cost_currency&#39;</span><span class="p">],</span>
                              <span class="n">value</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">total_cost_l</span><span class="p">[</span><span class="n">i_prj</span><span class="p">],</span> <span class="mi">4</span><span class="p">))</span>
        <span class="c1"># Add total of the spreadsheet, this can be equal or bigger than</span>
        <span class="c1"># than the sum of the above totals, because, in the case of partial</span>
        <span class="c1"># or fractional quantity of one part or subpart, the total quantity</span>
        <span class="c1"># column &#39;qty&#39; will be the ceil of the sum of the other ones.</span>
        <span class="n">total_cost_row</span> <span class="o">=</span> <span class="n">start_row</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># Change the position of the total price cell.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Cost for 1 board when we only have 1 project</span>
        <span class="n">wks</span><span class="o">.</span><span class="n">write_formula</span><span class="p">(</span><span class="n">total_cost_row</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">total_cost_col</span><span class="p">,</span> <span class="s2">&quot;=TotalCost/BoardQty&quot;</span><span class="p">,</span> <span class="n">ss</span><span class="o">.</span><span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;unit_cost_currency&#39;</span><span class="p">],</span>
                          <span class="n">value</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">total_cost</span><span class="o">/</span><span class="n">ss</span><span class="o">.</span><span class="n">prj_info</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;qty&#39;</span><span class="p">],</span> <span class="mi">4</span><span class="p">))</span>
    <span class="n">total_cost_range</span> <span class="o">=</span> <span class="n">xl_range</span><span class="p">(</span><span class="n">PART_INFO_FIRST_ROW</span><span class="p">,</span> <span class="n">total_cost_col</span><span class="p">,</span> <span class="n">PART_INFO_LAST_ROW</span><span class="p">)</span>
    <span class="n">wks</span><span class="o">.</span><span class="n">write_formula</span><span class="p">(</span><span class="n">total_cost_row</span><span class="p">,</span> <span class="n">total_cost_col</span><span class="p">,</span> <span class="s1">&#39;=SUM(</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">total_cost_range</span><span class="p">),</span> <span class="n">ss</span><span class="o">.</span><span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;total_cost_currency&#39;</span><span class="p">],</span> <span class="n">value</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">total_cost</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

    <span class="c1"># Add the total purchase and others purchase informations.</span>
    <span class="k">if</span> <span class="n">ss</span><span class="o">.</span><span class="n">DISTRIBUTORS</span><span class="p">:</span>
        <span class="n">next_line</span> <span class="o">=</span> <span class="n">row</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">ss</span><span class="o">.</span><span class="n">write_string</span><span class="p">(</span><span class="n">next_line</span><span class="p">,</span> <span class="n">col_unit_price</span><span class="p">,</span> <span class="s1">&#39;Total Purchase:&#39;</span><span class="p">,</span> <span class="s1">&#39;total_cost_label&#39;</span><span class="p">)</span>
        <span class="n">wks</span><span class="o">.</span><span class="n">write_comment</span><span class="p">(</span><span class="n">next_line</span><span class="p">,</span> <span class="n">col_unit_price</span><span class="p">,</span> <span class="s1">&#39;This is the total of your cart across all distributors.&#39;</span><span class="p">)</span>
        <span class="n">dist_ext_prices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">col_ext_dist</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">DISTRIBUTOR_COLUMNS</span><span class="p">[</span><span class="s1">&#39;ext_price&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">dist</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ss</span><span class="o">.</span><span class="n">DISTRIBUTORS</span><span class="p">):</span>
            <span class="c1"># Get the content of the extended price</span>
            <span class="n">dist_ext_prices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xl_rowcol_to_cell</span><span class="p">(</span><span class="n">next_line</span><span class="p">,</span> <span class="n">dist_cols</span><span class="p">[</span><span class="n">dist</span><span class="p">]</span> <span class="o">+</span> <span class="n">col_ext_dist</span><span class="p">))</span>
        <span class="n">wks</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">next_line</span><span class="p">,</span> <span class="n">col_ext_price</span><span class="p">,</span> <span class="s1">&#39;=SUM(</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dist_ext_prices</span><span class="p">)),</span> <span class="n">ss</span><span class="o">.</span><span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;total_cost_currency&#39;</span><span class="p">])</span>
        <span class="c1"># Purchase general description, it may be used to distinguish carts of different projects.</span>
        <span class="n">next_line</span> <span class="o">=</span> <span class="n">next_line</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">ss</span><span class="o">.</span><span class="n">write_string</span><span class="p">(</span><span class="n">next_line</span><span class="p">,</span> <span class="n">col_unit_price</span><span class="p">,</span> <span class="s1">&#39;Purchase description:&#39;</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">)</span>
        <span class="n">wks</span><span class="o">.</span><span class="n">write_comment</span><span class="p">(</span><span class="n">next_line</span><span class="p">,</span> <span class="n">col_unit_price</span><span class="p">,</span>
                          <span class="s1">&#39;This description will be added to all purchased parts label and may be used to distinguish the &#39;</span> <span class="o">+</span>
                          <span class="s1">&#39;component of different projects.&#39;</span><span class="p">)</span>
        <span class="n">ss</span><span class="o">.</span><span class="n">define_name_ref</span><span class="p">(</span><span class="s1">&#39;PURCHASE_DESCRIPTION&#39;</span><span class="p">,</span> <span class="n">next_line</span><span class="p">,</span> <span class="n">col</span><span class="p">[</span><span class="s1">&#39;ext_price&#39;</span><span class="p">])</span>

    <span class="c1"># Get the actual currency rate to use.</span>
    <span class="n">next_line</span> <span class="o">=</span> <span class="n">row</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">used_currencies</span><span class="p">:</span>
        <span class="n">used_currencies</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">DEFAULT_CURRENCY</span><span class="p">)</span>
    <span class="n">used_currencies</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">used_currencies</span><span class="p">))</span>
    <span class="n">debug_overview</span><span class="p">(</span><span class="s1">&#39;Getting distributor currency convertion rate </span><span class="si">{}</span><span class="s1"> to </span><span class="si">{}</span><span class="s1">...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">used_currencies</span><span class="p">,</span> <span class="n">ss</span><span class="o">.</span><span class="n">currency</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">used_currencies</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ss</span><span class="o">.</span><span class="n">currency</span> <span class="ow">in</span> <span class="n">used_currencies</span><span class="p">:</span>
            <span class="n">used_currencies</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ss</span><span class="o">.</span><span class="n">currency</span><span class="p">)</span>
        <span class="n">wks</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">next_line</span><span class="p">,</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">col</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">],</span>
                  <span class="s1">&#39;Used currency rates:&#39;</span><span class="p">,</span> <span class="n">ss</span><span class="o">.</span><span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">])</span>
        <span class="n">next_line</span> <span class="o">=</span> <span class="n">next_line</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">used_currency</span> <span class="ow">in</span> <span class="n">used_currencies</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">used_currency</span> <span class="o">!=</span> <span class="n">ss</span><span class="o">.</span><span class="n">currency</span><span class="p">:</span>
            <span class="n">wks</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">next_line</span><span class="p">,</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">col</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">],</span>
                      <span class="s1">&#39;</span><span class="si">{c}</span><span class="s1">(</span><span class="si">{c_s}</span><span class="s1">)/</span><span class="si">{d}</span><span class="s1">(</span><span class="si">{d_s}</span><span class="s1">):&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="o">=</span><span class="n">ss</span><span class="o">.</span><span class="n">currency</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">used_currency</span><span class="p">,</span> <span class="n">c_s</span><span class="o">=</span><span class="n">ss</span><span class="o">.</span><span class="n">currency_symbol</span><span class="p">,</span>
                                                      <span class="n">d_s</span><span class="o">=</span><span class="n">get_currency_symbol</span><span class="p">(</span><span class="n">used_currency</span><span class="p">,</span> <span class="n">locale</span><span class="o">=</span><span class="n">DEFAULT_LANGUAGE</span><span class="p">)),</span>
                      <span class="n">ss</span><span class="o">.</span><span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">])</span>
            <span class="n">ss</span><span class="o">.</span><span class="n">define_name_ref</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{c}</span><span class="s1">_</span><span class="si">{d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="o">=</span><span class="n">ss</span><span class="o">.</span><span class="n">currency</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">used_currency</span><span class="p">),</span> <span class="n">next_line</span><span class="p">,</span> <span class="n">col</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">wks</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">next_line</span><span class="p">,</span> <span class="n">col</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">currency_convert</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">used_currency</span><span class="p">,</span> <span class="n">ss</span><span class="o">.</span><span class="n">currency</span><span class="p">))</span>
            <span class="n">next_line</span> <span class="o">=</span> <span class="n">next_line</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="c1"># Return column following the globals so we know where to start next set of cells.</span>
    <span class="c1"># Also return the columns where the references and quantity needed of each part are stored.</span>
    <span class="k">return</span> <span class="n">next_line</span>


<span class="k">def</span> <span class="nf">add_dist_to_worksheet</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span> <span class="n">columns_global</span><span class="p">,</span> <span class="n">start_row</span><span class="p">,</span> <span class="n">start_col</span><span class="p">,</span> <span class="n">unit_cost_row</span><span class="p">,</span> <span class="n">total_cost_row</span><span class="p">,</span> <span class="n">part_ref_col</span><span class="p">,</span> <span class="n">part_qty_col</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="n">parts</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Add distributor-specific part data to the spreadsheet.&#39;&#39;&#39;</span>

    <span class="n">info</span> <span class="o">=</span> <span class="n">get_distributor_info</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">order</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">name</span>
    <span class="n">debug_overview</span><span class="p">(</span><span class="s1">&#39;# Writing </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">))</span>
    <span class="n">wks</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">wks</span>
    <span class="c1"># Columns for the various types of distributor-specific part data.</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">DISTRIBUTOR_COLUMNS</span>
    <span class="n">num_cols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
    <span class="n">row</span> <span class="o">=</span> <span class="n">start_row</span>  <span class="c1"># Start building distributor section at this row.</span>

    <span class="c1"># Add label for this distributor.</span>
    <span class="n">wks</span><span class="o">.</span><span class="n">merge_range</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">start_col</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">num_cols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">ss</span><span class="o">.</span><span class="n">wrk_formats</span><span class="p">[</span><span class="n">dist</span><span class="p">])</span>
    <span class="c1"># if info.is_web():</span>
    <span class="c1">#     ss.write_url(row, start_col, info.label.url, ss.wrk_formats[dist], label)</span>
    <span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># Go to next row.</span>

    <span class="c1"># Add column headers, comments, and outline level (for hierarchy).</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;col&#39;</span><span class="p">]</span>  <span class="c1"># Column index for this column.</span>
        <span class="n">ss</span><span class="o">.</span><span class="n">write_string</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">],</span> <span class="s1">&#39;header&#39;</span><span class="p">)</span>
        <span class="n">wks</span><span class="o">.</span><span class="n">write_comment</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;comment&#39;</span><span class="p">])</span>
        <span class="n">ss</span><span class="o">.</span><span class="n">set_column</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">],</span> <span class="n">v</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;collapsed&#39;</span><span class="p">))</span>
    <span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># Go to next row.</span>

    <span class="n">num_parts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>
    <span class="n">num_prj</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ss</span><span class="o">.</span><span class="n">prj_info</span><span class="p">)</span>
    <span class="c1"># Add distributor data for each part.</span>
    <span class="n">PART_INFO_FIRST_ROW</span> <span class="o">=</span> <span class="n">row</span>  <span class="c1"># Starting row of part info.</span>
    <span class="n">PART_INFO_LAST_ROW</span> <span class="o">=</span> <span class="n">PART_INFO_FIRST_ROW</span> <span class="o">+</span> <span class="n">num_parts</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># Last row of part info.</span>

    <span class="n">col_part_num</span> <span class="o">=</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;part_num&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">]</span>
    <span class="n">col_purch</span> <span class="o">=</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;purch&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">]</span>
    <span class="n">col_unit_price</span> <span class="o">=</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;unit_price&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">]</span>
    <span class="n">col_ext_price</span> <span class="o">=</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;ext_price&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">]</span>
    <span class="n">col_moq</span> <span class="o">=</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;moq&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ss</span><span class="o">.</span><span class="n">SUPPRESS_DIST_DESC</span><span class="p">:</span>
        <span class="n">col_desc</span> <span class="o">=</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">]</span>
    <span class="n">total_cost</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># How many parts were found at this distributor</span>
    <span class="n">n_price_found</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">num_prj</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">n_price_found_l</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">num_prj</span>
        <span class="n">total_cost_l</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">num_prj</span>
    <span class="c1"># Empty object used when no data is available for a distributor</span>
    <span class="n">empty_dd</span> <span class="o">=</span> <span class="n">DistData</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">:</span>
        <span class="c1"># Get the DistData for this distributor</span>
        <span class="n">dd</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">dd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">empty_dd</span><span class="p">)</span>
        <span class="n">dist_part_num</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">part_num</span>  <span class="c1"># Get the distributor part number.</span>
        <span class="n">price_tiers</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">price_tiers</span>  <span class="c1"># Extract price tiers from distributor HTML page tree.</span>
        <span class="n">dist_qty_avail</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">qty_avail</span>
        <span class="c1"># If the part number doesn&#39;t exist, just leave this row blank.</span>
        <span class="c1"># if dist_part_num is None or dist_qty_avail is None or len(price_tiers) == 0:</span>
        <span class="k">if</span> <span class="n">dist_part_num</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># Skip this row and go to the next.</span>
            <span class="k">continue</span>
        <span class="n">dist_info_dist</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">extra_info</span>
        <span class="n">dist_currency</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">currency</span>  <span class="c1"># Extract currency used by the distributor.</span>

        <span class="c1"># Enter distributor part number for ordering purposes.</span>
        <span class="k">if</span> <span class="n">dist_part_num</span><span class="p">:</span>
            <span class="n">wks</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col_part_num</span><span class="p">,</span> <span class="n">dist_part_num</span><span class="p">,</span> <span class="n">ss</span><span class="o">.</span><span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;part_format&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ss</span><span class="o">.</span><span class="n">SUPPRESS_CAT_URL</span><span class="p">:</span>
                <span class="n">dist_part_num</span> <span class="o">=</span> <span class="s1">&#39;Link&#39;</span>  <span class="c1"># To use as text for the link.</span>
        <span class="c1"># Add a comment in the &#39;cat#&#39; column with extra information from the distributor web page.</span>
        <span class="c1"># Note: Not supported by any of the current APIs</span>
        <span class="n">comment</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">([</span><span class="n">k</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="o">+</span><span class="n">SEPRTR</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dist_info_dist</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ss</span><span class="o">.</span><span class="n">extra_info_display</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">comment</span><span class="p">:</span>
            <span class="n">wks</span><span class="o">.</span><span class="n">write_comment</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col_part_num</span><span class="p">,</span> <span class="n">comment</span><span class="p">)</span>

        <span class="c1"># Enter a link to the distributor webpage for this part, even if there</span>
        <span class="c1"># is no valid quantity or pricing for the part (see next conditional).</span>
        <span class="c1"># Having the link present will help debug if the extraction of the</span>
        <span class="c1"># quantity or pricing information was done correctly.</span>
        <span class="n">dist_url</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">url</span>
        <span class="k">if</span> <span class="n">dist_url</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ss</span><span class="o">.</span><span class="n">SUPPRESS_CAT_URL</span><span class="p">:</span>
                <span class="n">ss</span><span class="o">.</span><span class="n">write_url</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col_part_num</span><span class="p">,</span> <span class="n">dist_url</span><span class="p">,</span> <span class="s1">&#39;part_format&#39;</span><span class="p">,</span> <span class="n">dist_part_num</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ss</span><span class="o">.</span><span class="n">write_url</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;link&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">],</span> <span class="n">dist_url</span><span class="p">,</span> <span class="s1">&#39;part_format&#39;</span><span class="p">)</span>

        <span class="c1"># Available parts for this distributor unless it is None which means the part is not stocked.</span>
        <span class="n">col_avail</span> <span class="o">=</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;avail&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">dist_qty_avail</span><span class="p">:</span>
            <span class="n">wks</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col_avail</span><span class="p">,</span> <span class="n">dist_qty_avail</span><span class="p">,</span> <span class="n">ss</span><span class="o">.</span><span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;part_format&#39;</span><span class="p">])</span>
            <span class="n">qty_avail_comment</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">qty_avail_comment</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wks</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col_avail</span><span class="p">,</span> <span class="s1">&#39;NonStk&#39;</span><span class="p">,</span> <span class="n">ss</span><span class="o">.</span><span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;not_stocked&#39;</span><span class="p">])</span>
            <span class="n">qty_avail_comment</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">qty_avail_comment</span> <span class="ow">or</span> <span class="s1">&#39;This part is listed but is not stocked.&#39;</span>
        <span class="k">if</span> <span class="n">qty_avail_comment</span><span class="p">:</span>
            <span class="n">wks</span><span class="o">.</span><span class="n">write_comment</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col_avail</span><span class="p">,</span> <span class="n">qty_avail_comment</span><span class="p">)</span>

        <span class="c1"># Purchase quantity always starts as blank because nothing has been purchased yet.</span>
        <span class="n">wks</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col_purch</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">ss</span><span class="o">.</span><span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;part_format&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">ss</span><span class="o">.</span><span class="n">SUPPRESS_DIST_DESC</span> <span class="ow">and</span> <span class="s1">&#39;desc&#39;</span> <span class="ow">in</span> <span class="n">dist_info_dist</span><span class="p">:</span>
            <span class="n">ss</span><span class="o">.</span><span class="n">write_string</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col_desc</span><span class="p">,</span> <span class="n">dist_info_dist</span><span class="p">[</span><span class="s1">&#39;desc&#39;</span><span class="p">],</span> <span class="s1">&#39;part_format&#39;</span><span class="p">)</span>

        <span class="c1"># Add pricing information if it exists. (Unit$/Ext$)</span>
        <span class="k">if</span> <span class="n">price_tiers</span><span class="p">:</span>
            <span class="c1"># Update the &quot;parts found information&quot;</span>
            <span class="n">n_price_found</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">part_qty_cell</span> <span class="o">=</span> <span class="n">xl_rowcol_to_cell</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">part_qty_col</span><span class="p">)</span>
            <span class="n">purch_cell</span> <span class="o">=</span> <span class="n">xl_rowcol_to_cell</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col_purch</span><span class="p">)</span>
            <span class="c1"># Add the price for a single unit if it doesn&#39;t already exist in the tiers.</span>
            <span class="n">min_qty</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">price_tiers</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">minimum_order_qty</span> <span class="o">=</span> <span class="n">min_qty</span>  <span class="c1"># Update the minimum order quantity.</span>
            <span class="k">if</span> <span class="n">min_qty</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">price_tiers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">price_tiers</span><span class="p">[</span><span class="n">min_qty</span><span class="p">]</span>  <span class="c1"># Set unit price to price of lowest available quantity.</span>
            <span class="n">price_tiers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.00</span>  <span class="c1"># Enter quantity-zero pricing so `LOOKUP` works correctly in the spreadsheet.</span>
            <span class="c1"># Sort the tiers based on quantities and turn them into lists of strings.</span>
            <span class="n">qtys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">price_tiers</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="c1"># Enter a spreadsheet lookup function that determines the unit price based on the needed quantity</span>
            <span class="c1"># or the purchased quantity (if that is non-zero).</span>
            <span class="n">rate</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">rate_n</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">dist_currency</span> <span class="o">!=</span> <span class="n">ss</span><span class="o">.</span><span class="n">currency</span><span class="p">:</span>
                <span class="c1"># The distributor currency isn&#39;t the one used for all the rest.</span>
                <span class="c1"># We must apply a conversion rate.</span>
                <span class="n">rate</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{c}</span><span class="s1">_</span><span class="si">{d}</span><span class="s1">*&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="o">=</span><span class="n">ss</span><span class="o">.</span><span class="n">currency</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">dist_currency</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">rate_n</span> <span class="o">=</span> <span class="n">currency_convert</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dist_currency</span><span class="p">,</span> <span class="n">ss</span><span class="o">.</span><span class="n">currency</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">KiCostError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; in &#39;</span> <span class="o">+</span> <span class="n">part</span><span class="o">.</span><span class="n">collapsed_refs</span><span class="p">,</span> <span class="n">ERR_FIELDS</span><span class="p">)</span>
            <span class="c1">#</span>
            <span class="c1"># Unit$</span>
            <span class="c1">#</span>
            <span class="c1"># Create a comment to the cell showing the qty/price breaks.</span>
            <span class="n">dist_currency_symbol</span> <span class="o">=</span> <span class="n">get_currency_symbol</span><span class="p">(</span><span class="n">dist_currency</span><span class="p">,</span> <span class="n">locale</span><span class="o">=</span><span class="n">DEFAULT_LANGUAGE</span><span class="p">)</span>
            <span class="n">price_break_info</span> <span class="o">=</span> <span class="s1">&#39;Qty/Price Breaks (</span><span class="si">{c}</span><span class="s1">):</span><span class="se">\n</span><span class="s1">  Qty  -  Unit</span><span class="si">{s}</span><span class="s1">  -  Ext</span><span class="si">{s}</span><span class="se">\n</span><span class="s1">================&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="o">=</span><span class="n">dist_currency</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">dist_currency_symbol</span><span class="p">)</span>
            <span class="n">unit_price</span> <span class="o">=</span> <span class="n">price_tiers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">qtys</span><span class="p">[</span><span class="mi">1</span> <span class="k">if</span> <span class="n">minimum_order_qty</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">2</span><span class="p">:]:</span>
                <span class="c1"># Skip the unity quantity for the tip balloon if it isn&#39;t allowed in the distributor.</span>
                <span class="n">price</span> <span class="o">=</span> <span class="n">price_tiers</span><span class="p">[</span><span class="n">q</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">q</span> <span class="o">&lt;=</span> <span class="n">part</span><span class="o">.</span><span class="n">qty_total_spreadsheet</span><span class="p">:</span>
                    <span class="c1"># Use this price for the cell</span>
                    <span class="n">unit_price</span> <span class="o">=</span> <span class="n">price</span>
                <span class="n">price_fmt</span> <span class="o">=</span> <span class="n">format_currency</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="n">dist_currency</span><span class="p">,</span> <span class="n">locale</span><span class="o">=</span><span class="n">DEFAULT_LANGUAGE</span><span class="p">)</span>
                <span class="n">priceq_fmt</span> <span class="o">=</span> <span class="n">format_currency</span><span class="p">(</span><span class="n">price</span><span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="n">dist_currency</span><span class="p">,</span> <span class="n">locale</span><span class="o">=</span><span class="n">DEFAULT_LANGUAGE</span><span class="p">)</span>
                <span class="n">price_break_info</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="si">{:&gt;6d}</span><span class="s1"> </span><span class="si">{:&gt;7s}</span><span class="s1"> </span><span class="si">{:&gt;10s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">price_fmt</span><span class="p">,</span> <span class="n">priceq_fmt</span><span class="p">)</span>
            <span class="c1"># Add the formula</span>
            <span class="n">unit_price</span> <span class="o">*=</span> <span class="n">rate_n</span>
            <span class="c1"># This is the price lookup</span>
            <span class="n">uprice_f</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">{rate}</span><span class="s1">LOOKUP(IF(</span><span class="si">{purch_qty}</span><span class="s1">=&quot;&quot;,</span><span class="si">{needed_qty}</span><span class="s1">,</span><span class="si">{purch_qty}</span><span class="s1">),{{</span><span class="si">{qtys}</span><span class="s1">}},{{</span><span class="si">{prices}</span><span class="s1">}})&#39;</span><span class="o">.</span>
                        <span class="nb">format</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="n">rate</span><span class="p">,</span> <span class="n">needed_qty</span><span class="o">=</span><span class="n">part_qty_cell</span><span class="p">,</span> <span class="n">purch_qty</span><span class="o">=</span><span class="n">purch_cell</span><span class="p">,</span> <span class="n">qtys</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">qtys</span><span class="p">]),</span>
                               <span class="n">prices</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">price_tiers</span><span class="p">[</span><span class="n">q</span><span class="p">])</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">qtys</span><span class="p">])))</span>
            <span class="c1"># But discard it if the ammount isn&#39;t enough to cover the MOQ</span>
            <span class="n">moq_cell</span> <span class="o">=</span> <span class="n">xl_rowcol_to_cell</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col_moq</span><span class="p">)</span>
            <span class="n">uprice_f</span> <span class="o">=</span> <span class="s1">&#39;IF(OR(</span><span class="si">{purch}</span><span class="s1">&gt;=</span><span class="si">{moq}</span><span class="s1">,</span><span class="si">{qty}</span><span class="s1">&gt;=</span><span class="si">{moq}</span><span class="s1">),</span><span class="si">{price}</span><span class="s1">,&quot;MOQ=&quot;&amp;</span><span class="si">{moq}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">purch</span><span class="o">=</span><span class="n">purch_cell</span><span class="p">,</span> <span class="n">moq</span><span class="o">=</span><span class="n">moq_cell</span><span class="p">,</span> <span class="n">qty</span><span class="o">=</span><span class="n">part_qty_cell</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="n">uprice_f</span><span class="p">)</span>
            <span class="n">blank_up</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">qty_total_spreadsheet</span> <span class="o">&lt;</span> <span class="n">minimum_order_qty</span>
            <span class="c1"># Add the formula, but blank the cell on error</span>
            <span class="n">wks</span><span class="o">.</span><span class="n">write_formula</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col_unit_price</span><span class="p">,</span> <span class="s1">&#39;=IFERROR(</span><span class="si">{}</span><span class="s1">,&quot;&quot;)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">uprice_f</span><span class="p">),</span> <span class="n">ss</span><span class="o">.</span><span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;currency_unit&#39;</span><span class="p">],</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">blank_up</span> <span class="k">else</span> <span class="n">unit_price</span><span class="p">)</span>
            <span class="c1"># Add the comment</span>
            <span class="n">wks</span><span class="o">.</span><span class="n">write_comment</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col_unit_price</span><span class="p">,</span> <span class="n">price_break_info</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">blank_up</span> <span class="ow">and</span> <span class="p">(</span><span class="n">part</span><span class="o">.</span><span class="n">min_price</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">unit_price</span> <span class="o">&lt;</span> <span class="n">part</span><span class="o">.</span><span class="n">min_price</span><span class="p">):</span>
                <span class="n">part</span><span class="o">.</span><span class="n">min_price</span> <span class="o">=</span> <span class="n">unit_price</span>
            <span class="c1">#</span>
            <span class="c1"># MOQ</span>
            <span class="c1">#</span>
            <span class="n">wks</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col_moq</span><span class="p">,</span> <span class="n">minimum_order_qty</span><span class="p">,</span> <span class="n">ss</span><span class="o">.</span><span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;part_format&#39;</span><span class="p">])</span>
            <span class="c1">#</span>
            <span class="c1"># Ext$ (purch qty * unit price.)</span>
            <span class="c1">#</span>
            <span class="n">ext_price</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">qty_total_spreadsheet</span><span class="o">*</span><span class="n">unit_price</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">blank_up</span><span class="p">:</span>
                <span class="n">total_cost</span> <span class="o">+=</span> <span class="n">ext_price</span>
            <span class="n">wks</span><span class="o">.</span><span class="n">write_formula</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col_ext_price</span><span class="p">,</span> <span class="s1">&#39;=IFERROR(IF(</span><span class="si">{purch_qty}</span><span class="s1">=&quot;&quot;,</span><span class="si">{needed_qty}</span><span class="s1">,</span><span class="si">{purch_qty}</span><span class="s1">)*</span><span class="si">{unit_price}</span><span class="s1">,&quot;&quot;)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                              <span class="n">needed_qty</span><span class="o">=</span><span class="n">part_qty_cell</span><span class="p">,</span>
                              <span class="n">purch_qty</span><span class="o">=</span><span class="n">purch_cell</span><span class="p">,</span>
                              <span class="n">unit_price</span><span class="o">=</span><span class="n">xl_rowcol_to_cell</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col_unit_price</span><span class="p">)),</span> <span class="n">ss</span><span class="o">.</span><span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;currency&#39;</span><span class="p">],</span>
                              <span class="c1"># Limit the resolution (to make it more reproducible)</span>
                              <span class="n">value</span><span class="o">=</span><span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">blank_up</span> <span class="k">else</span> <span class="nb">round</span><span class="p">(</span><span class="n">ext_price</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
            <span class="c1"># Update the number of parts found and total cost for multiprojects</span>
            <span class="k">if</span> <span class="n">num_prj</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">q</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">part</span><span class="o">.</span><span class="n">qty</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">q</span><span class="p">:</span>
                        <span class="n">n_price_found_l</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">total_cost_l</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">q</span> <span class="o">*</span> <span class="n">unit_price</span> <span class="o">*</span> <span class="n">ss</span><span class="o">.</span><span class="n">prj_info</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;qty&#39;</span><span class="p">]</span>
            <span class="c1">#</span>
            <span class="c1"># Conditional formats:</span>
            <span class="c1">#</span>
            <span class="c1"># No quantity is available.</span>
            <span class="c1"># The following condition is never met because we use NonStk instead of 0</span>
            <span class="c1"># ss.conditional_format(row, col_avail, &#39;==&#39;, &#39;not_available&#39;, 0)</span>
            <span class="c1"># Available quantity is less than required.</span>
            <span class="n">ss</span><span class="o">.</span><span class="n">conditional_format</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col_avail</span><span class="p">,</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="s1">&#39;too_few_available&#39;</span><span class="p">,</span> <span class="n">part_qty_cell</span><span class="p">)</span>
            <span class="c1"># Minimum order quantity not respected.</span>
            <span class="k">if</span> <span class="n">minimum_order_qty</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">criteria</span> <span class="o">=</span> <span class="s1">&#39;=AND(</span><span class="si">{q}</span><span class="s1">&gt;0,MOD(</span><span class="si">{q}</span><span class="s1">,</span><span class="si">{moq}</span><span class="s1">)&lt;&gt;0)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">q</span><span class="o">=</span><span class="n">purch_cell</span><span class="p">,</span> <span class="n">moq</span><span class="o">=</span><span class="n">moq_cell</span><span class="p">)</span>
                <span class="n">ss</span><span class="o">.</span><span class="n">conditional_format</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col_purch</span><span class="p">,</span> <span class="n">criteria</span><span class="p">,</span> <span class="s1">&#39;order_min_qty&#39;</span><span class="p">)</span>
            <span class="c1"># Purchase quantity is more than what is available.</span>
            <span class="n">criteria</span> <span class="o">=</span> <span class="s1">&#39;=AND(NOT(ISBLANK(</span><span class="si">{q}</span><span class="s1">)),OR(</span><span class="si">{avail}</span><span class="s1">=&quot;NonStk&quot;,</span><span class="si">{q}</span><span class="s1">&gt;</span><span class="si">{avail}</span><span class="s1">))&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">q</span><span class="o">=</span><span class="n">purch_cell</span><span class="p">,</span> <span class="n">avail</span><span class="o">=</span><span class="n">xl_rowcol_to_cell</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col_avail</span><span class="p">))</span>
            <span class="n">ss</span><span class="o">.</span><span class="n">conditional_format</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col_purch</span><span class="p">,</span> <span class="n">criteria</span><span class="p">,</span> <span class="s1">&#39;order_too_much&#39;</span><span class="p">)</span>
            <span class="c1"># Best price (only for more than one distributor)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ss</span><span class="o">.</span><span class="n">DISTRIBUTORS</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Extended price cell that contains the best price.</span>
                <span class="c1"># part_qty_col+2 is the global data cell holding the minimum extended price for this part.</span>
                <span class="n">ss</span><span class="o">.</span><span class="n">conditional_format</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col_ext_price</span><span class="p">,</span> <span class="s1">&#39;&lt;=&#39;</span><span class="p">,</span> <span class="s1">&#39;best_price&#39;</span><span class="p">,</span> <span class="n">xl_rowcol_to_cell</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">part_qty_col</span><span class="o">+</span><span class="mi">2</span><span class="p">))</span>
                <span class="c1"># Unit price cell that contains the best price.</span>
                <span class="c1"># part_qty_col+1 is the global data cell holding the minimum unit price for this part.</span>
                <span class="n">ss</span><span class="o">.</span><span class="n">conditional_format</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col_unit_price</span><span class="p">,</span> <span class="s1">&#39;&lt;=&#39;</span><span class="p">,</span> <span class="s1">&#39;best_price&#39;</span><span class="p">,</span> <span class="n">xl_rowcol_to_cell</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">part_qty_col</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
                <span class="c1"># Mark cells with a MOQ bigger than what we need</span>
                <span class="k">if</span> <span class="n">blank_up</span><span class="p">:</span>
                    <span class="n">criteria</span> <span class="o">=</span> <span class="s1">&#39;=AND(</span><span class="si">{qt}</span><span class="s1">&lt;</span><span class="si">{moq}</span><span class="s1">,</span><span class="si">{q}</span><span class="s1">&lt;</span><span class="si">{moq}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">qt</span><span class="o">=</span><span class="n">part_qty_cell</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="n">purch_cell</span><span class="p">,</span> <span class="n">moq</span><span class="o">=</span><span class="n">minimum_order_qty</span><span class="p">)</span>
                    <span class="c1"># Libreoffice 7 woraround: conditional formats applied to ranges only affects the first cell, so we use just cells</span>
                    <span class="n">ss</span><span class="o">.</span><span class="n">conditional_format</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col_unit_price</span><span class="p">,</span> <span class="n">criteria</span><span class="p">,</span> <span class="s1">&#39;order_min_qty&#39;</span><span class="p">)</span>
                    <span class="n">ss</span><span class="o">.</span><span class="n">conditional_format</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col_moq</span><span class="p">,</span> <span class="n">criteria</span><span class="p">,</span> <span class="s1">&#39;order_min_qty&#39;</span><span class="p">)</span>
                    <span class="n">ss</span><span class="o">.</span><span class="n">conditional_format</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col_ext_price</span><span class="p">,</span> <span class="n">criteria</span><span class="p">,</span> <span class="s1">&#39;order_min_qty&#39;</span><span class="p">)</span>

        <span class="c1"># Finished processing distributor data for this part.</span>
        <span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># Go to next row.</span>

    <span class="c1"># If more than one file (multi-files mode) show how many</span>
    <span class="c1"># parts of each BOM we found at this distributor and</span>
    <span class="c1"># the correspondent total price.</span>
    <span class="n">ext_price_range</span> <span class="o">=</span> <span class="n">xl_range</span><span class="p">(</span><span class="n">PART_INFO_FIRST_ROW</span><span class="p">,</span> <span class="n">col_ext_price</span><span class="p">,</span> <span class="n">PART_INFO_LAST_ROW</span><span class="p">)</span>
    <span class="n">moq_range</span> <span class="o">=</span> <span class="n">xl_range</span><span class="p">(</span><span class="n">PART_INFO_FIRST_ROW</span><span class="p">,</span> <span class="n">col_moq</span><span class="p">,</span> <span class="n">PART_INFO_LAST_ROW</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">num_prj</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i_prj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_prj</span><span class="p">):</span>
            <span class="c1"># Sum the extended prices (unit multiplied by quantity) for each file/BOM.</span>
            <span class="n">qty_prj_col</span> <span class="o">=</span> <span class="n">part_qty_col</span> <span class="o">-</span> <span class="p">(</span><span class="n">num_prj</span> <span class="o">-</span> <span class="n">i_prj</span><span class="p">)</span>
            <span class="n">qty_prj_range</span> <span class="o">=</span> <span class="n">xl_range</span><span class="p">(</span><span class="n">PART_INFO_FIRST_ROW</span><span class="p">,</span> <span class="n">qty_prj_col</span><span class="p">,</span> <span class="n">PART_INFO_LAST_ROW</span><span class="p">)</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">total_cost_row</span> <span class="o">+</span> <span class="n">i_prj</span> <span class="o">*</span> <span class="n">ss</span><span class="o">.</span><span class="n">PRJ_INFO_ROWS</span>
            <span class="n">wks</span><span class="o">.</span><span class="n">write_formula</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col_ext_price</span><span class="p">,</span> <span class="s1">&#39;=SUMPRODUCT(</span><span class="si">{qty_range}</span><span class="s1">,</span><span class="si">{unit_price_range}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">qty_range</span><span class="o">=</span><span class="n">qty_prj_range</span><span class="p">,</span>
                              <span class="n">unit_price_range</span><span class="o">=</span><span class="n">xl_range</span><span class="p">(</span><span class="n">PART_INFO_FIRST_ROW</span><span class="p">,</span> <span class="n">col_unit_price</span><span class="p">,</span> <span class="n">PART_INFO_LAST_ROW</span><span class="p">)),</span>
                              <span class="n">ss</span><span class="o">.</span><span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;total_cost_currency&#39;</span><span class="p">],</span> <span class="n">value</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">total_cost_l</span><span class="p">[</span><span class="n">i_prj</span><span class="p">],</span> <span class="mi">4</span><span class="p">))</span>
            <span class="c1"># Show how many parts were found at this distributor.</span>
            <span class="n">wks</span><span class="o">.</span><span class="n">write_formula</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col_part_num</span><span class="p">,</span> <span class="s1">&#39;=COUNTIFS(</span><span class="si">{price_range}</span><span class="s1">,&quot;&lt;&gt;&quot;,</span><span class="si">{qty_range}</span><span class="s1">,&quot;&lt;&gt;0&quot;,</span><span class="si">{qty_range}</span><span class="s1">,&quot;&lt;&gt;&quot;)&amp;&quot; of &quot;&amp;COUNTIFS(</span><span class="si">{qty_range}</span><span class="s1">,&quot;&lt;&gt;0&quot;,&#39;</span>
                              <span class="s1">&#39;</span><span class="si">{qty_range}</span><span class="s1">,&quot;&lt;&gt;&quot;)&amp;&quot; parts found&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">price_range</span><span class="o">=</span><span class="n">ext_price_range</span><span class="p">,</span> <span class="n">qty_range</span><span class="o">=</span><span class="n">qty_prj_range</span><span class="p">),</span>
                              <span class="n">ss</span><span class="o">.</span><span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;found_part_pct&#39;</span><span class="p">],</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> of </span><span class="si">{}</span><span class="s1"> parts found&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n_price_found_l</span><span class="p">[</span><span class="n">i_prj</span><span class="p">],</span> <span class="n">ss</span><span class="o">.</span><span class="n">num_parts</span><span class="p">[</span><span class="n">i_prj</span><span class="p">]))</span>
            <span class="n">wks</span><span class="o">.</span><span class="n">write_comment</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col_part_num</span><span class="p">,</span> <span class="s1">&#39;Number of parts found at this distributor for the project </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i_prj</span><span class="p">))</span>
        <span class="n">total_cost_row</span> <span class="o">=</span> <span class="n">PART_INFO_FIRST_ROW</span> <span class="o">-</span> <span class="mi">3</span>  <span class="c1"># Shift the total price in this distributor.</span>

    <span class="c1"># Sum the extended prices for all the parts to get the total cost from this distributor.</span>
    <span class="n">wks</span><span class="o">.</span><span class="n">write_formula</span><span class="p">(</span><span class="n">total_cost_row</span><span class="p">,</span> <span class="n">col_ext_price</span><span class="p">,</span> <span class="s1">&#39;=SUM(</span><span class="si">{sum_range}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sum_range</span><span class="o">=</span><span class="n">ext_price_range</span><span class="p">),</span> <span class="n">ss</span><span class="o">.</span><span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;total_cost_currency&#39;</span><span class="p">],</span>
                      <span class="c1"># Limit the resolution (to make it more reproducible)</span>
                      <span class="n">value</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">total_cost</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="c1"># Show how many parts were found at this distributor.</span>
    <span class="c1"># Note: the formula could help the user to remove prices and add parts</span>
    <span class="n">wks</span><span class="o">.</span><span class="n">write_formula</span><span class="p">(</span><span class="n">total_cost_row</span><span class="p">,</span> <span class="n">col_part_num</span><span class="p">,</span> <span class="s1">&#39;=(COUNTA(</span><span class="si">{count_range}</span><span class="s1">)&amp;&quot; of &quot;&amp;ROWS(</span><span class="si">{count_range}</span><span class="s1">)&amp;&quot; parts found&quot;)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                      <span class="n">count_range</span><span class="o">=</span><span class="n">ext_price_range</span><span class="p">),</span> <span class="n">ss</span><span class="o">.</span><span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;found_part_pct&#39;</span><span class="p">],</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> of </span><span class="si">{}</span><span class="s1"> parts found&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n_price_found</span><span class="p">,</span> <span class="n">num_parts</span><span class="p">))</span>
    <span class="n">wks</span><span class="o">.</span><span class="n">write_comment</span><span class="p">(</span><span class="n">total_cost_row</span><span class="p">,</span> <span class="n">col_part_num</span><span class="p">,</span> <span class="s1">&#39;Number of parts found at this distributor.&#39;</span><span class="p">)</span>

    <span class="c1"># Add list of part numbers and purchase quantities for ordering from this distributor.</span>
    <span class="n">ORDER_START_COL</span> <span class="o">=</span> <span class="n">start_col</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">ORDER_FIRST_ROW</span> <span class="o">=</span> <span class="n">PART_INFO_LAST_ROW</span> <span class="o">+</span> <span class="mi">3</span>

    <span class="c1"># Write the header and how many parts are being purchased.</span>
    <span class="n">ORDER_HEADER</span> <span class="o">=</span> <span class="n">PART_INFO_LAST_ROW</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">purch_range</span> <span class="o">=</span> <span class="n">xl_range</span><span class="p">(</span><span class="n">PART_INFO_FIRST_ROW</span><span class="p">,</span> <span class="n">col_purch</span><span class="p">,</span> <span class="n">PART_INFO_LAST_ROW</span><span class="p">)</span>
    <span class="c1"># Expended in this distributor.</span>
    <span class="n">wks</span><span class="o">.</span><span class="n">write_formula</span><span class="p">(</span><span class="n">ORDER_HEADER</span><span class="p">,</span> <span class="n">col_ext_price</span><span class="p">,</span> <span class="s1">&#39;=SUMIF(</span><span class="si">{count_range}</span><span class="s1">,&quot;&gt;0&quot;,</span><span class="si">{price_range}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                      <span class="n">count_range</span><span class="o">=</span><span class="n">purch_range</span><span class="p">,</span>
                      <span class="n">price_range</span><span class="o">=</span><span class="n">ext_price_range</span><span class="p">),</span> <span class="n">ss</span><span class="o">.</span><span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;total_cost_currency&#39;</span><span class="p">])</span>
    <span class="c1"># Quantity of purchased parts in this distributor.</span>
    <span class="n">do_count</span> <span class="o">=</span> <span class="s1">&#39;COUNTIF(</span><span class="si">{range}</span><span class="s1">,&quot;&gt;0&quot;)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">range</span><span class="o">=</span><span class="n">purch_range</span><span class="p">)</span>
    <span class="n">wks</span><span class="o">.</span><span class="n">write_formula</span><span class="p">(</span><span class="n">ORDER_HEADER</span><span class="p">,</span> <span class="n">col_purch</span><span class="p">,</span> <span class="s1">&#39;=IFERROR(IF(</span><span class="si">{count}</span><span class="s1">&gt;0,</span><span class="si">{count}</span><span class="s1">&amp;&quot; of &quot;&amp;(ROWS(</span><span class="si">{range_moq}</span><span class="s1">)-COUNTBLANK(</span><span class="si">{range_moq}</span><span class="s1">))&amp;&quot; parts purchased&quot;,&quot;&quot;),&quot;&quot;)&#39;</span><span class="o">.</span>
                      <span class="nb">format</span><span class="p">(</span><span class="n">count</span><span class="o">=</span><span class="n">do_count</span><span class="p">,</span> <span class="n">range_moq</span><span class="o">=</span><span class="n">moq_range</span><span class="p">),</span> <span class="n">ss</span><span class="o">.</span><span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;found_part_pct&#39;</span><span class="p">],</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">wks</span><span class="o">.</span><span class="n">write_comment</span><span class="p">(</span><span class="n">ORDER_HEADER</span><span class="p">,</span> <span class="n">col_purch</span><span class="p">,</span> <span class="s1">&#39;Copy the information below to the BOM import page of the distributor web site.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">url</span><span class="p">:</span>
        <span class="n">ss</span><span class="o">.</span><span class="n">write_url</span><span class="p">(</span><span class="n">ORDER_HEADER</span><span class="p">,</span> <span class="n">col_purch</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">order</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Buy here&#39;</span><span class="p">)</span>

    <span class="c1"># Write the spreadsheet code to multiple lines to create the purchase codes to</span>
    <span class="c1"># be used in this current distributor.</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">cols</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cols</span><span class="p">:</span>
        <span class="n">debug_overview</span><span class="p">(</span><span class="s2">&quot;Purchase list codes for </span><span class="si">{d}</span><span class="s2"> will not be generated: no information provided.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="o">=</span><span class="n">label</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">num_cols</span>  <span class="c1"># If not created the distributor definition, jump this final code part.</span>

    <span class="k">if</span> <span class="n">ORDER_COL_USERFIELDS</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
        <span class="c1"># It is requested all the user fields at the purchase code,</span>
        <span class="c1"># replace the virtual annotation provided by `ORDER_COL_USERFIELDS`</span>
        <span class="c1"># by all user fields in the spreadsheet. This keep the compatibility</span>
        <span class="c1"># and configuration possibility for other features.</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">cols</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">ORDER_COL_USERFIELDS</span><span class="p">)</span>  <span class="c1"># Find the first occurrence.</span>
        <span class="k">del</span> <span class="n">cols</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">cols_user</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">columns_global</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">cols</span><span class="o">+</span><span class="p">[</span><span class="s1">&#39;refs&#39;</span><span class="p">,</span> <span class="s1">&#39;qty&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;footprint&#39;</span><span class="p">,</span> <span class="s1">&#39;unit_price&#39;</span><span class="p">,</span> <span class="s1">&#39;ext_price&#39;</span><span class="p">,</span> <span class="s1">&#39;manf#&#39;</span><span class="p">,</span> <span class="s1">&#39;part_num&#39;</span><span class="p">,</span> <span class="s1">&#39;purch&#39;</span><span class="p">,</span> <span class="s1">&#39;desc&#39;</span><span class="p">]):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cols_user</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="n">debug_overview</span><span class="p">(</span><span class="s2">&quot;Add the </span><span class="si">{f}</span><span class="s2"> information for the </span><span class="si">{d}</span><span class="s2"> purchase list code.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">cols_user</span><span class="p">))</span>
        <span class="n">cols</span><span class="p">[</span><span class="n">idx</span><span class="p">:</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">cols_user</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="s1">&#39;purch&#39;</span> <span class="ow">in</span> <span class="n">cols</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;part_num&#39;</span> <span class="ow">in</span> <span class="n">cols</span> <span class="ow">or</span> <span class="s1">&#39;manf#&#39;</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">)):</span>
        <span class="n">debug_overview</span><span class="p">(</span><span class="s2">&quot;Purchase list codes for </span><span class="si">{d}</span><span class="s2"> will not be generated: no stock# of manf# format defined.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="o">=</span><span class="n">label</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">num_cols</span>  <span class="c1"># Skip the order creation.</span>

    <span class="c1"># Create the order using the fields specified by each distributor.</span>
    <span class="n">ORDER_FIRST_ROW</span> <span class="o">=</span> <span class="n">ORDER_FIRST_ROW</span> <span class="o">+</span> <span class="n">num_parts</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">first_part</span> <span class="o">=</span> <span class="n">PART_INFO_FIRST_ROW</span>
    <span class="n">last_part</span> <span class="o">=</span> <span class="n">PART_INFO_FIRST_ROW</span> <span class="o">+</span> <span class="n">num_parts</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="c1"># The columns needed for this distributor</span>
    <span class="n">order_part_info</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Format the columns</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
        <span class="c1"># Look for the `col` name into the distributor spreadsheet part</span>
        <span class="c1"># with don&#39;t find, it belongs to the global part.</span>
        <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
            <span class="n">info_col</span> <span class="o">=</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns_global</span><span class="p">:</span>
            <span class="n">info_col</span> <span class="o">=</span> <span class="n">columns_global</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">info_col</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># None is used to generate an empty column, isn&#39;t a problem</span>
                <span class="n">warning</span><span class="p">(</span><span class="n">W_NOPURCH</span><span class="p">,</span> <span class="s2">&quot;Not valid field `</span><span class="si">{f}</span><span class="s2">` for purchase list at </span><span class="si">{d}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">label</span><span class="p">))</span>
        <span class="n">cell</span> <span class="o">=</span> <span class="n">xl_range</span><span class="p">(</span><span class="n">first_part</span><span class="p">,</span> <span class="n">info_col</span><span class="p">,</span> <span class="n">last_part</span><span class="p">)</span>
        <span class="c1"># Deal with conversion and string replace necessary to the correct distributors</span>
        <span class="c1"># code understanding.</span>
        <span class="k">if</span> <span class="n">col</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">columns</span> <span class="ow">and</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">columns_global</span><span class="p">):</span>
            <span class="c1"># Create an empty column escaping all the information, same when is asked</span>
            <span class="c1"># for a not present filed at the global column (`columns_global`) part or</span>
            <span class="c1"># distributors columns part (`columns`).</span>
            <span class="n">order_part_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&quot;&quot;&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">col</span> <span class="o">==</span> <span class="s1">&#39;purch&#39;</span><span class="p">:</span>
            <span class="c1"># Add text conversion if is a numeric cell.</span>
            <span class="c1"># Also make it a multiple of the MOQ.</span>
            <span class="c1"># Note: IF(ISNUMBER({moq}),{moq},1) prevents a /0 error</span>
            <span class="n">order_part_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;TEXT(ROUNDUP(</span><span class="si">{purch}</span><span class="s1">/IF(ISNUMBER(</span><span class="si">{moq}</span><span class="s1">),</span><span class="si">{moq}</span><span class="s1">,1),0)*</span><span class="si">{moq}</span><span class="s1">,&quot;##0&quot;)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">purch</span><span class="o">=</span><span class="n">cell</span><span class="p">,</span> <span class="n">moq</span><span class="o">=</span><span class="n">moq_range</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;part_num&#39;</span><span class="p">,</span> <span class="s1">&#39;manf#&#39;</span><span class="p">]:</span>
            <span class="c1"># Part number goes without changes</span>
            <span class="n">order_part_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># All comment and description columns (that are not quantity and catalogue code)</span>
            <span class="c1"># These are text informative columns.</span>
            <span class="c1"># They can include the purchase designator</span>
            <span class="n">cell</span> <span class="o">=</span> <span class="s1">&#39;IF(PURCHASE_DESCRIPTION&lt;&gt;&quot;&quot;,PURCHASE_DESCRIPTION&amp;&quot;</span><span class="si">{}</span><span class="s1">&quot;,&quot;&quot;)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ss</span><span class="o">.</span><span class="n">purchase_description_seprtr</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&amp;&#39;</span> <span class="o">+</span> <span class="n">cell</span>
            <span class="c1"># They should respect the allowed characters.</span>
            <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">not_allowed_char</span> <span class="ow">and</span> <span class="n">order</span><span class="o">.</span><span class="n">replace_by_char</span><span class="p">:</span>
                <span class="n">multi_replace</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">replace_by_char</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
                <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">not_allowed_char</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">not_allowed_char</span><span class="p">):</span>
                    <span class="n">replace_by_char</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">replace_by_char</span><span class="p">[</span><span class="n">c</span> <span class="k">if</span> <span class="n">multi_replace</span> <span class="k">else</span> <span class="mi">0</span><span class="p">]</span>
                    <span class="n">cell</span> <span class="o">=</span> <span class="s1">&#39;SUBSTITUTE(</span><span class="si">{t}</span><span class="s1">,&quot;</span><span class="si">{o}</span><span class="s1">&quot;,&quot;</span><span class="si">{n}</span><span class="s1">&quot;)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="n">cell</span><span class="p">,</span> <span class="n">o</span><span class="o">=</span><span class="n">not_allowed_char</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">replace_by_char</span><span class="p">)</span>
            <span class="c1"># A limit could be applied</span>
            <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">limit</span><span class="p">:</span>
                <span class="n">cell</span> <span class="o">=</span> <span class="s1">&#39;LEFT(</span><span class="si">{}</span><span class="s1">,</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">order</span><span class="o">.</span><span class="n">limit</span><span class="p">)</span>
            <span class="n">order_part_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="c1"># Join the columns</span>
    <span class="c1">#</span>
    <span class="c1"># These are the columns where the part catalog numbers and purchase quantities can be found.</span>
    <span class="k">if</span> <span class="s1">&#39;part_num&#39;</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
        <span class="n">part_col</span> <span class="o">=</span> <span class="n">col_part_num</span>
    <span class="k">elif</span> <span class="s1">&#39;manf#&#39;</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
        <span class="n">part_col</span> <span class="o">=</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns_global</span><span class="p">[</span><span class="s1">&#39;manf#&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">part_col</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">warning</span><span class="p">(</span><span class="n">W_NOQTY</span><span class="p">,</span> <span class="s2">&quot;The </span><span class="si">{}</span><span class="s2"> distributor order info doesn&#39;t include the part number.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dist</span><span class="p">))</span>
    <span class="n">part_range</span> <span class="o">=</span> <span class="n">xl_range</span><span class="p">(</span><span class="n">first_part</span><span class="p">,</span> <span class="n">part_col</span><span class="p">,</span> <span class="n">last_part</span><span class="p">)</span>
    <span class="n">qty_col</span> <span class="o">=</span> <span class="n">col_purch</span>
    <span class="n">qty_range</span> <span class="o">=</span> <span class="n">xl_range</span><span class="p">(</span><span class="n">first_part</span><span class="p">,</span> <span class="n">qty_col</span><span class="p">,</span> <span class="n">last_part</span><span class="p">)</span>
    <span class="n">conditional</span> <span class="o">=</span> <span class="s1">&#39;=IF(ISNUMBER(</span><span class="si">{qty}</span><span class="s1">)*(</span><span class="si">{qty}</span><span class="s1">&gt;=</span><span class="si">{moq}</span><span class="s1">)*(</span><span class="si">{catn}</span><span class="s1">&lt;&gt;&quot;&quot;),{{}}&amp;CHAR(10),&quot;&quot;)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">qty</span><span class="o">=</span><span class="n">qty_range</span><span class="p">,</span> <span class="n">catn</span><span class="o">=</span><span class="n">part_range</span><span class="p">,</span> <span class="n">moq</span><span class="o">=</span><span class="n">moq_range</span><span class="p">)</span>
    <span class="n">array_range</span> <span class="o">=</span> <span class="n">xl_range</span><span class="p">(</span><span class="n">ORDER_FIRST_ROW</span><span class="p">,</span> <span class="n">ORDER_START_COL</span><span class="p">,</span> <span class="n">ORDER_FIRST_ROW</span> <span class="o">+</span> <span class="n">num_parts</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="c1"># Concatenation operator plus distributor code delimiter.</span>
    <span class="n">delimiter</span> <span class="o">=</span> <span class="s1">&#39;&amp;&quot;&#39;</span> <span class="o">+</span> <span class="n">order</span><span class="o">.</span><span class="n">delimiter</span> <span class="o">+</span> <span class="s1">&#39;&quot;&amp;&#39;</span>
    <span class="c1"># Write a parallel formula to compute all the lines in one operation (array formula)</span>
    <span class="n">wks</span><span class="o">.</span><span class="n">write_array_formula</span><span class="p">(</span><span class="n">array_range</span><span class="p">,</span> <span class="n">conditional</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">delimiter</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">order_part_info</span><span class="p">)),</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="c1"># Hide the individual results, but make them twice as high, so we can see the value and \n when visible</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_parts</span><span class="p">):</span>
        <span class="n">wks</span><span class="o">.</span><span class="n">set_row</span><span class="p">(</span><span class="n">ORDER_FIRST_ROW</span> <span class="o">+</span> <span class="n">r</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;hidden&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
    <span class="c1">#</span>
    <span class="c1"># Consolidate the order using CONCATENATE</span>
    <span class="c1">#</span>
    <span class="c1"># CONCATENATE doesn&#39;t work with ranges (some implementations does others don&#39;t), so we list the cells manually</span>
    <span class="n">order_cells</span> <span class="o">=</span> <span class="p">[</span><span class="n">xl_rowcol_to_cell</span><span class="p">(</span><span class="n">ORDER_FIRST_ROW</span> <span class="o">+</span> <span class="n">r</span><span class="p">,</span> <span class="n">ORDER_START_COL</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_parts</span><span class="p">)]</span>
    <span class="c1"># Create the header of the purchase codes (only for some distributors)</span>
    <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">header</span><span class="p">:</span>
        <span class="n">cur_row</span> <span class="o">=</span> <span class="n">ORDER_FIRST_ROW</span> <span class="o">+</span> <span class="n">num_parts</span>
        <span class="n">wks</span><span class="o">.</span><span class="n">write_formula</span><span class="p">(</span><span class="n">cur_row</span><span class="p">,</span> <span class="n">ORDER_START_COL</span><span class="p">,</span>
                          <span class="s1">&#39;=IFERROR(IF(COUNTIFS(</span><span class="si">{count_range}</span><span class="s1">,&quot;&gt;0&quot;,</span><span class="si">{count_range_price}</span><span class="s1">,&quot;&lt;&gt;&quot;)&gt;0,&quot;</span><span class="si">{header}</span><span class="s1">&quot;&amp;CHAR(10),&quot;&quot;),&quot;&quot;)&#39;</span>
                          <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">count_range</span><span class="o">=</span><span class="n">purch_range</span><span class="p">,</span> <span class="n">count_range_price</span><span class="o">=</span><span class="n">ext_price_range</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">order</span><span class="o">.</span><span class="n">header</span><span class="p">),</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="c1"># Insert the header as the first line</span>
        <span class="n">order_cells</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">xl_rowcol_to_cell</span><span class="p">(</span><span class="n">cur_row</span><span class="p">,</span> <span class="n">ORDER_START_COL</span><span class="p">))</span>
        <span class="c1"># Hide it</span>
        <span class="n">wks</span><span class="o">.</span><span class="n">set_row</span><span class="p">(</span><span class="n">cur_row</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;hidden&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
    <span class="c1"># Merge the cells to provide enough space for the order</span>
    <span class="n">first_row</span> <span class="o">=</span> <span class="n">ORDER_FIRST_ROW</span> <span class="o">-</span> <span class="n">num_parts</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">wks</span><span class="o">.</span><span class="n">merge_range</span><span class="p">(</span><span class="n">first_row</span><span class="p">,</span> <span class="n">ORDER_START_COL</span><span class="p">,</span> <span class="n">ORDER_FIRST_ROW</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ORDER_START_COL</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="c1"># Now the final order is ready</span>
    <span class="c1"># We also put the order.info text here, to make it more visible, will go away as soon a component is purchased</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">info</span> <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">info</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
    <span class="c1"># Just join the texts using CONCATENATE</span>
    <span class="n">wks</span><span class="o">.</span><span class="n">write_formula</span><span class="p">(</span><span class="n">first_row</span><span class="p">,</span> <span class="n">ORDER_START_COL</span><span class="p">,</span> <span class="s1">&#39;=CONCATENATE(</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">order_cells</span><span class="p">)),</span> <span class="n">ss</span><span class="o">.</span><span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">],</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
        <span class="n">wks</span><span class="o">.</span><span class="n">write_comment</span><span class="p">(</span><span class="n">first_row</span><span class="p">,</span> <span class="n">ORDER_START_COL</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">num_cols</span>  <span class="c1"># Return column following the globals so we know where to start next set of cells.</span>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">kicost 1.1.20 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">kicost.spreadsheet</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2015, XESS Corporation.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 5.3.0.
    </div>
  </body>
</html>